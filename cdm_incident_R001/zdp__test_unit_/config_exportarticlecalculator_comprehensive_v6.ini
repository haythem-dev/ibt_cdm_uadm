
# ==============================================================================
# Export Article Calculator Module Validation Configuration - VERSION 6
# esqltest Framework Configuration File
# 
# Module: pharmos.base.cdm/dev/src/batch/exportarticlecalculator
# Purpose: Comprehensive validation of export article calculation business logic
# Date: 2025-01-27
# Version: 6.0 (Fixed syntax errors and connection handling)
# ==============================================================================

[general]
database=ich21@zdev21_tcp
test_capture_entries_count=10
keepDBConnection=1
separator=;
timeout=300
commit_interval=1

# ==============================================================================
# PHASE 1: SETUP - Create temporary tables and reference data
# ==============================================================================

# Create export exclusion parameter table
[transaction00]
sql=CREATE TEMP TABLE temp_exportexclusionparameter ( \
    country VARCHAR(3) NOT NULL, \
    branchno SMALLINT NOT NULL, \
    rule_id SMALLINT NOT NULL, \
    rule_name VARCHAR(50), \
    parameter_value VARCHAR(100), \
    activation_flag SMALLINT DEFAULT 1, \
    lastchangedatetime DATETIME YEAR TO SECOND, \
    PRIMARY KEY (country, branchno, rule_id) \
);

# Create article master table - FIXED: removed trailing comma
[transaction01]
sql=CREATE TEMP TABLE temp_article_master ( \
    article_no INTEGER NOT NULL PRIMARY KEY, \
    article_name VARCHAR(80), \
    manufacturer VARCHAR(40), \
    atc_code VARCHAR(20), \
    narcotics_flag SMALLINT DEFAULT 0, \
    un_no VARCHAR(10), \
    notifiable_flag SMALLINT DEFAULT 0, \
    explosion_flag SMALLINT DEFAULT 0, \
    psychotropic_flag SMALLINT DEFAULT 0, \
    animal_medicine_flag SMALLINT DEFAULT 0, \
    narcotic_substance_flag SMALLINT DEFAULT 0, \
    distribution_binding_mode VARCHAR(20), \
    distribution_binding_ifa VARCHAR(20), \
    prismae_no INTEGER, \
    export_block_flag SMALLINT DEFAULT 0, \
    outsale_date INTEGER, \
    expiry_date INTEGER, \
    biozid_flag VARCHAR(1), \
    article_locked_flag VARCHAR(1), \
    storage_location VARCHAR(20), \
    active_article_flag VARCHAR(1) DEFAULT 'Y', \
    cool_article_mode VARCHAR(20), \
    hazardous_substance_old SMALLINT DEFAULT 0, \
    hazardous_substance_new SMALLINT DEFAULT 0, \
    homeopathy_flag VARCHAR(1) DEFAULT 'N', \
    anthroposophic_flag VARCHAR(1) DEFAULT 'N', \
    medicine_flag VARCHAR(1) DEFAULT 'Y', \
    lastchangedatetime DATETIME YEAR TO SECOND \
);

# Create export article table
[transaction02]
sql=CREATE TEMP TABLE temp_exportarticle ( \
    article_no INTEGER NOT NULL, \
    country VARCHAR(3) NOT NULL, \
    branchno SMALLINT NOT NULL, \
    export_permission_flag SMALLINT DEFAULT 1, \
    last_update_date INTEGER, \
    change_counter INTEGER DEFAULT 0, \
    PRIMARY KEY (article_no, country, branchno) \
);

# Create processing stats table
[transaction03]
sql=CREATE TEMP TABLE temp_processing_stats ( \
    stat_type VARCHAR(30), \
    rule_id SMALLINT, \
    rule_name VARCHAR(50), \
    article_count INTEGER, \
    exclusion_count INTEGER, \
    processed_count INTEGER DEFAULT 0, \
    description VARCHAR(100) \
);

# Create branch info table
[transaction04]
sql=CREATE TEMP TABLE temp_branch_info ( \
    branchno SMALLINT NOT NULL PRIMARY KEY, \
    branchname VARCHAR(40), \
    country VARCHAR(3), \
    region VARCHAR(20), \
    active_flag SMALLINT DEFAULT 1 \
);

# ==============================================================================
# PHASE 2: REFERENCE DATA LOADING - Individual INSERT statements
# ==============================================================================

# Load branch reference data
[transaction05]
sql=INSERT INTO temp_branch_info (branchno, branchname, country, region, active_flag) VALUES (10, 'Central Pharmacy Berlin', 'DE', 'North', 1);

[transaction06]
sql=INSERT INTO temp_branch_info (branchno, branchname, country, region, active_flag) VALUES (20, 'Regional Pharmacy Munich', 'DE', 'South', 1);

[transaction07]
sql=INSERT INTO temp_branch_info (branchno, branchname, country, region, active_flag) VALUES (30, 'Metro Pharmacy Vienna', 'AT', 'Central', 1);

# Load export exclusion parameters
[transaction08]
sql=INSERT INTO temp_exportexclusionparameter (country, branchno, rule_id, rule_name, parameter_value, activation_flag, lastchangedatetime) VALUES ('DE', 10, 1, 'NARCOTICS', '1', 1, CURRENT);

[transaction09]
sql=INSERT INTO temp_exportexclusionparameter (country, branchno, rule_id, rule_name, parameter_value, activation_flag, lastchangedatetime) VALUES ('DE', 10, 2, 'UN_NO', 'NOT_NULL', 1, CURRENT);

[transaction10]
sql=INSERT INTO temp_exportexclusionparameter (country, branchno, rule_id, rule_name, parameter_value, activation_flag, lastchangedatetime) VALUES ('DE', 10, 3, 'NOTIFIABLE', '1', 1, CURRENT);

[transaction11]
sql=INSERT INTO temp_exportexclusionparameter (country, branchno, rule_id, rule_name, parameter_value, activation_flag, lastchangedatetime) VALUES ('DE', 10, 4, 'EXPLOSION', '1', 1, CURRENT);

[transaction12]
sql=INSERT INTO temp_exportexclusionparameter (country, branchno, rule_id, rule_name, parameter_value, activation_flag, lastchangedatetime) VALUES ('DE', 10, 5, 'PSYCHOTROPIC', '1', 1, CURRENT);

# Load article master test data - FIXED: Added missing fields
[transaction13]
sql=INSERT INTO temp_article_master (article_no, article_name, manufacturer, atc_code, active_article_flag, medicine_flag, lastchangedatetime) VALUES (100001, 'Aspirin 100mg', 'Bayer AG', 'B01AC06', 'Y', 'Y', CURRENT);

[transaction14]
sql=INSERT INTO temp_article_master (article_no, article_name, manufacturer, narcotics_flag, medicine_flag, lastchangedatetime) VALUES (100002, 'Morphine 10mg', 'Pharma Corp', 1, 'Y', CURRENT);

[transaction15]
sql=INSERT INTO temp_article_master (article_no, article_name, manufacturer, un_no, medicine_flag, lastchangedatetime) VALUES (100003, 'Ethanol Solution', 'Chemical Co', 'UN1170', 'N', CURRENT);

[transaction16]
sql=INSERT INTO temp_article_master (article_no, article_name, manufacturer, notifiable_flag, medicine_flag, lastchangedatetime) VALUES (100004, 'Radioactive Tracer', 'Nuclear Med', 1, 'Y', CURRENT);

[transaction17]
sql=INSERT INTO temp_article_master (article_no, article_name, manufacturer, explosion_flag, medicine_flag, lastchangedatetime) VALUES (100005, 'Nitroglycerin Tablets', 'CardioPharm', 1, 'Y', CURRENT);

# ==============================================================================
# PHASE 3: BASIC QUERY VALIDATION - Test core operations
# ==============================================================================

# Test data validation - count records
[transaction18]
sql=SELECT (COUNT(*) || ';TOTAL_BRANCH_RECORDS') AS result FROM temp_branch_info;
header=count;description

[transaction19]
sql=SELECT (COUNT(*) || ';TOTAL_EXCLUSION_PARAMETERS') AS result FROM temp_exportexclusionparameter;
header=count;description

[transaction20]
sql=SELECT (COUNT(*) || ';TOTAL_ARTICLE_RECORDS') AS result FROM temp_article_master;
header=count;description

# ==============================================================================
# PHASE 4: EXPORT ARTICLE PROCESSING - Core business logic
# ==============================================================================

# Initialize export article table with all articles allowed by default
[transaction21]
sql=INSERT INTO temp_exportarticle SELECT article_no, 'DE', 10, 1, 20250127, 0 FROM temp_article_master;

# Apply exclusion rules - narcotics
[transaction22]
sql=UPDATE temp_exportarticle SET export_permission_flag = 0, change_counter = change_counter + 1, last_update_date = 20250127 WHERE article_no IN (SELECT article_no FROM temp_article_master WHERE narcotics_flag = 1);

# Apply exclusion rules - UN dangerous goods
[transaction23]
sql=UPDATE temp_exportarticle SET export_permission_flag = 0, change_counter = change_counter + 1, last_update_date = 20250127 WHERE article_no IN (SELECT article_no FROM temp_article_master WHERE un_no IS NOT NULL);

# Apply exclusion rules - notifiable substances
[transaction24]
sql=UPDATE temp_exportarticle SET export_permission_flag = 0, change_counter = change_counter + 1, last_update_date = 20250127 WHERE article_no IN (SELECT article_no FROM temp_article_master WHERE notifiable_flag = 1);

# Apply exclusion rules - explosive substances
[transaction25]
sql=UPDATE temp_exportarticle SET export_permission_flag = 0, change_counter = change_counter + 1, last_update_date = 20250127 WHERE article_no IN (SELECT article_no FROM temp_article_master WHERE explosion_flag = 1);

# ==============================================================================
# PHASE 5: MEDICINE CLASSIFICATION LOGIC - Complex business rule
# ==============================================================================

# Test medicine classification rule (core business logic)
[transaction26]
sql=SELECT (a.article_no || ';' || a.article_name || ';' || NVL(a.atc_code, 'EMPTY') || ';' || a.homeopathy_flag || ';' || a.anthroposophic_flag || ';' || a.medicine_flag || ';MEDICINE_CLASSIFICATION') AS result FROM temp_article_master a WHERE a.medicine_flag = 'Y' ORDER BY a.article_no;
header=article_no;article_name;atc_code;homeopathy_flag;anthroposophic_flag;medicine_flag;test_type

# Apply medicine exclusion rule (medicines without ATC code, not homeopathic or anthroposophic)
[transaction27]
sql=UPDATE temp_exportarticle SET export_permission_flag = 0, change_counter = change_counter + 1 WHERE article_no IN (SELECT article_no FROM temp_article_master WHERE medicine_flag = 'Y' AND (atc_code IS NULL OR atc_code = '') AND homeopathy_flag != '1' AND anthroposophic_flag != '1');

# ==============================================================================
# PHASE 6: RULE APPLICATION VALIDATION - Test results
# ==============================================================================

# Check exclusion results by article
[transaction28]
sql=SELECT (e.article_no || ';' || a.article_name || ';' || e.export_permission_flag || ';' || CASE WHEN e.export_permission_flag = 0 THEN 'EXCLUDED' ELSE 'ALLOWED' END) AS result FROM temp_exportarticle e, temp_article_master a WHERE e.article_no = a.article_no ORDER BY e.article_no;
header=article_no;article_name;permission_flag;status

# Summary statistics
[transaction29]
sql=SELECT ('TOTAL_ARTICLES;' || COUNT(*) || ';Total articles processed') AS result FROM temp_exportarticle UNION ALL SELECT ('ALLOWED_EXPORTS;' || COUNT(*) || ';Articles allowed for export') AS result FROM temp_exportarticle WHERE export_permission_flag = 1 UNION ALL SELECT ('EXCLUDED_EXPORTS;' || COUNT(*) || ';Articles excluded from export') AS result FROM temp_exportarticle WHERE export_permission_flag = 0;
header=metric;count;description

# ==============================================================================
# PHASE 7: RULE COVERAGE VALIDATION - Test parameter application
# ==============================================================================

# Test rule parameter coverage
[transaction30]
sql=SELECT (p.rule_id || ';' || p.rule_name || ';' || CASE WHEN p.activation_flag = 1 THEN 'ACTIVE' ELSE 'INACTIVE' END || ';RULE_STATUS') AS result FROM temp_exportexclusionparameter p WHERE p.country = 'DE' AND p.branchno = 10 ORDER BY p.rule_id;
header=rule_id;rule_name;status;test_type

# Validate rule application by type
[transaction31]
sql=SELECT (a.article_no || ';' || a.article_name || ';' || a.narcotics_flag || ';NARCOTICS_RULE_TEST') AS result FROM temp_article_master a WHERE a.narcotics_flag = 1 ORDER BY a.article_no;
header=article_no;article_name;narcotics_flag;test_type

[transaction32]
sql=SELECT (a.article_no || ';' || a.article_name || ';' || NVL(a.un_no, 'NULL') || ';UN_NO_RULE_TEST') AS result FROM temp_article_master a WHERE a.un_no IS NOT NULL ORDER BY a.article_no;
header=article_no;article_name;un_no;test_type

# ==============================================================================
# PHASE 8: DATA QUALITY VALIDATION - Test data integrity
# ==============================================================================

# Data quality checks
[transaction33]
sql=INSERT INTO temp_processing_stats SELECT 'DATA_QUALITY', 0, 'null_atc_count', COUNT(*), 0, 0, 'Articles with NULL ATC code' FROM temp_article_master WHERE atc_code IS NULL;

[transaction34]
sql=INSERT INTO temp_processing_stats SELECT 'DATA_QUALITY', 0, 'null_un_no_count', COUNT(*), 0, 0, 'Articles with NULL UN number' FROM temp_article_master WHERE un_no IS NULL;

[transaction35]
sql=INSERT INTO temp_processing_stats SELECT 'DATA_QUALITY', 0, 'medicine_no_atc', COUNT(*), 0, 0, 'Medicines without ATC code' FROM temp_article_master WHERE medicine_flag = 'Y' AND (atc_code IS NULL OR atc_code = '');

# Display data quality results
[transaction36]
sql=SELECT (stat_type || ';' || rule_name || ';' || article_count || ';' || description) AS result FROM temp_processing_stats WHERE stat_type = 'DATA_QUALITY' ORDER BY rule_name;
header=stat_type;metric;count;description

# ==============================================================================
# PHASE 9: BUSINESS RULE INTEGRATION TEST - Complex scenario
# ==============================================================================

# Test combined exclusion rules
[transaction37]
sql=SELECT (e.article_no || ';' || a.article_name || ';' || e.change_counter || ';' || CASE WHEN e.change_counter > 1 THEN 'MULTIPLE_RULES' ELSE 'SINGLE_RULE' END || ';RULE_APPLICATION') AS result FROM temp_exportarticle e, temp_article_master a WHERE e.article_no = a.article_no AND e.export_permission_flag = 0 ORDER BY e.change_counter DESC, e.article_no;
header=article_no;article_name;change_counter;rule_type;test_type

# Processing summary by branch
[transaction38]
sql=SELECT (bi.branchname || ';' || COUNT(ea.article_no) || ';' || SUM(CASE WHEN ea.export_permission_flag = 1 THEN 1 ELSE 0 END) || ';' || SUM(CASE WHEN ea.export_permission_flag = 0 THEN 1 ELSE 0 END)) AS result FROM temp_branch_info bi LEFT JOIN temp_exportarticle ea ON bi.branchno = ea.branchno WHERE bi.country = 'DE' GROUP BY bi.branchno, bi.branchname ORDER BY bi.branchno;
header=branch_name;total_articles;allowed;excluded

# ==============================================================================
# PHASE 10: FINAL VALIDATION AND REPORTING
# ==============================================================================

# Final processing summary
[transaction39]
sql=INSERT INTO temp_processing_stats SELECT 'FINAL_SUMMARY', 0, 'total_processed', COUNT(*), 0, 0, 'Total articles processed' FROM temp_exportarticle;

[transaction40]
sql=INSERT INTO temp_processing_stats SELECT 'FINAL_SUMMARY', 0, 'exclusion_rate', COUNT(*), 0, 0, 'Articles excluded from export' FROM temp_exportarticle WHERE export_permission_flag = 0;

[transaction41]
sql=INSERT INTO temp_processing_stats SELECT 'FINAL_SUMMARY', 0, 'active_rules', COUNT(*), 0, 0, 'Active exclusion rules' FROM temp_exportexclusionparameter WHERE activation_flag = 1;

# Display final summary
[transaction42]
sql=SELECT (stat_type || ';' || rule_name || ';' || article_count || ';' || description) AS result FROM temp_processing_stats WHERE stat_type = 'FINAL_SUMMARY' ORDER BY rule_name;
header=summary_type;metric;count;description

# Final validation report
[transaction43]
sql=SELECT (ea.export_permission_flag || ';' || COUNT(*) || ';' || CASE WHEN ea.export_permission_flag = 1 THEN 'EXPORT_ALLOWED' ELSE 'EXPORT_BLOCKED' END || ';FINAL_STATUS') AS result FROM temp_exportarticle ea GROUP BY ea.export_permission_flag ORDER BY ea.export_permission_flag;
header=permission_flag;count;status;test_type

# ==============================================================================
# PHASE 11: CLEANUP - Drop temporary tables
# ==============================================================================

# Drop all temporary tables
[transaction44]
sql=DROP TABLE temp_exportexclusionparameter;

[transaction45]
sql=DROP TABLE temp_article_master;

[transaction46]
sql=DROP TABLE temp_exportarticle;

[transaction47]
sql=DROP TABLE temp_processing_stats;

[transaction48]
sql=DROP TABLE temp_branch_info;

# Final cleanup verification
[transaction49]
sql=SELECT (COUNT(*) || ';REMAINING_TEMP_TABLES') AS result FROM systables WHERE tabname LIKE 'temp_%';
header=count;description

# ==============================================================================
# END OF CONFIGURATION - TOTAL TRANSACTIONS: 50 (sequential numbering 00-49)
# ==============================================================================
