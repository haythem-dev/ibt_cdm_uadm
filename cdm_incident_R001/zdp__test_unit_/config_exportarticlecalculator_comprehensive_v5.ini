
# ==============================================================================
# ESQLTEST Configuration for Export Article Calculator Module - VERSION 5
# Module: pharmos.base.cdm/dev/src/batch/exportarticlecalculator
# Purpose: Comprehensive validation of export article exclusion rules and calculations
# Changes: Fixed all remaining Informix compatibility issues from exec_v4.txt analysis
# Fixed: Transaction syntax errors, table references, and connection issues
# ==============================================================================

[general]
database=ich21@zdev21_tcp
test_capture_entries_count=10
persistent_connection=1
separator=;
timeout=300
commit_interval=50

# ==============================================================================
# PHASE 1: SETUP - Create temporary tables and reference data
# ==============================================================================

# Create main exclusion parameter table
[transaction00]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_exportexclusionparameter ( \
    country VARCHAR(3) NOT NULL, \
    branchno SMALLINT NOT NULL, \
    rule_id SMALLINT NOT NULL, \
    rule_name VARCHAR(50), \
    parameter_value VARCHAR(100), \
    activation_flag SMALLINT DEFAULT 1, \
    lastchangedatetime DATETIME YEAR TO SECOND, \
    PRIMARY KEY (country, branchno, rule_id) \
);

# Create article master table with corrected syntax
[transaction01]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_article_master ( \
    article_no INTEGER NOT NULL PRIMARY KEY, \
    article_name VARCHAR(80), \
    manufacturer VARCHAR(40), \
    atc_code VARCHAR(20), \
    narcotics_flag SMALLINT DEFAULT 0, \
    un_no VARCHAR(10), \
    notifiable_flag SMALLINT DEFAULT 0, \
    explosion_flag SMALLINT DEFAULT 0, \
    psychotropic_flag SMALLINT DEFAULT 0, \
    animal_medicine_flag SMALLINT DEFAULT 0, \
    narcotic_substance_flag SMALLINT DEFAULT 0, \
    distribution_binding_mode VARCHAR(20), \
    distribution_binding_ifa VARCHAR(20), \
    prismae_no INTEGER, \
    export_block_flag SMALLINT DEFAULT 0, \
    outsale_date INTEGER, \
    expiry_date INTEGER, \
    biozid_flag VARCHAR(1), \
    article_locked_flag VARCHAR(1), \
    storage_location VARCHAR(20), \
    active_article_flag VARCHAR(1) DEFAULT 'Y', \
    cool_article_mode VARCHAR(20), \
    hazardous_substance_old SMALLINT DEFAULT 0, \
    hazardous_substance_new SMALLINT DEFAULT 0, \
    homeopathy_flag VARCHAR(1) DEFAULT 'N', \
    anthroposophic_flag VARCHAR(1) DEFAULT 'N', \
    medicine_flag VARCHAR(1) DEFAULT 'Y', \
    lastchangedatetime DATETIME YEAR TO SECOND \
);

# Create export article table
[transaction02]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_exportarticle ( \
    article_no INTEGER NOT NULL, \
    country VARCHAR(3) NOT NULL, \
    branchno SMALLINT NOT NULL, \
    export_permission_flag SMALLINT DEFAULT 1, \
    last_update_date INTEGER, \
    change_counter INTEGER DEFAULT 0, \
    PRIMARY KEY (article_no, country, branchno) \
);

# Create processing stats table
[transaction03]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_processing_stats ( \
    stat_type VARCHAR(30), \
    rule_id SMALLINT, \
    rule_name VARCHAR(50), \
    article_count INTEGER, \
    exclusion_count INTEGER, \
    processed_count INTEGER DEFAULT 0, \
    description VARCHAR(100) \
);

# Create branch info table
[transaction04]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_branch_info ( \
    branchno SMALLINT NOT NULL PRIMARY KEY, \
    branchname VARCHAR(40), \
    country VARCHAR(3), \
    region VARCHAR(20), \
    active_flag SMALLINT DEFAULT 1 \
);

# ==============================================================================
# PHASE 2: REFERENCE DATA LOADING - Individual INSERT statements
# ==============================================================================

# Load branch reference data
[transaction05]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_info \
(branchno, branchname, country, region, active_flag) VALUES \
(10, 'Central Pharmacy Berlin', 'DE', 'North', 1);

[transaction06]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_info \
(branchno, branchname, country, region, active_flag) VALUES \
(20, 'Regional Pharmacy Munich', 'DE', 'South', 1);

[transaction07]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_info \
(branchno, branchname, country, region, active_flag) VALUES \
(30, 'Metro Pharmacy Vienna', 'AT', 'Central', 1);

[transaction08]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_info \
(branchno, branchname, country, region, active_flag) VALUES \
(40, 'City Pharmacy Zurich', 'CH', 'West', 1);

[transaction09]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_info \
(branchno, branchname, country, region, active_flag) VALUES \
(50, 'District Pharmacy Prague', 'CZ', 'East', 1);

# Load exclusion parameter rules
[transaction10]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag, lastchangedatetime) VALUES \
('DE', 10, 1, 'NARCOTICS', '1', 1, CURRENT);

[transaction11]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag, lastchangedatetime) VALUES \
('DE', 10, 2, 'UN_NO', 'NOT_NULL', 1, CURRENT);

[transaction12]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag, lastchangedatetime) VALUES \
('DE', 10, 3, 'NOTIFIABLE', '1', 1, CURRENT);

[transaction13]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag, lastchangedatetime) VALUES \
('DE', 10, 4, 'EXPLOSION', '1', 1, CURRENT);

[transaction14]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag, lastchangedatetime) VALUES \
('DE', 10, 5, 'PSYCHOTROPIC', '1', 1, CURRENT);

# Load test article data - corrected with lastchangedatetime field
[transaction15]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, atc_code, active_article_flag, medicine_flag, lastchangedatetime) VALUES \
(100001, 'Aspirin 100mg', 'Bayer AG', 'B01AC06', 'Y', 'Y', CURRENT);

[transaction16]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, narcotics_flag, medicine_flag, lastchangedatetime) VALUES \
(100002, 'Morphine 10mg', 'Pharma Corp', 1, 'Y', CURRENT);

[transaction17]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, un_no, medicine_flag, lastchangedatetime) VALUES \
(100003, 'Ethanol Solution', 'Chemical Co', 'UN1170', 'N', CURRENT);

[transaction18]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, notifiable_flag, medicine_flag, lastchangedatetime) VALUES \
(100004, 'Radioactive Tracer', 'Nuclear Med', 1, 'Y', CURRENT);

[transaction19]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, explosion_flag, medicine_flag, lastchangedatetime) VALUES \
(100005, 'Nitroglycerin Tablets', 'CardioPharm', 1, 'Y', CURRENT);

[transaction20]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, psychotropic_flag, atc_code, medicine_flag, lastchangedatetime) VALUES \
(100006, 'Diazepam 5mg', 'BenzoPharm', 1, 'N05BA01', 'Y', CURRENT);

# ==============================================================================
# PHASE 3: CORE BUSINESS LOGIC TESTING
# ==============================================================================

# Test basic exclusion rule validation
[transaction21]
sql=SELECT (country || ';' || branchno || ';' || rule_id || ';' || rule_name || ';' || activation_flag) AS result \
FROM ich21@zdev21_tcp:temp_exportexclusionparameter \
WHERE country = 'DE' AND branchno = 10 \
ORDER BY rule_id;
header=country;branchno;rule_id;rule_name;activation_flag

# Test article count validation
[transaction22]
sql=SELECT (COUNT(*) || ';TOTAL_ARTICLES_LOADED') AS result \
FROM ich21@zdev21_tcp:temp_article_master;
header=count;description

# Test exclusion rules count
[transaction23]
sql=SELECT (COUNT(*) || ';TOTAL_RULES_LOADED') AS result \
FROM ich21@zdev21_tcp:temp_exportexclusionparameter;
header=count;description

# Test narcotics exclusion rule
[transaction24]
sql=SELECT (a.article_no || ';' || a.article_name || ';' || a.narcotics_flag || ';NARCOTICS_RULE') AS result \
FROM ich21@zdev21_tcp:temp_article_master a \
WHERE a.narcotics_flag = 1 \
ORDER BY a.article_no;
header=article_no;article_name;narcotics_flag;rule_type

# Test UN number exclusion rule
[transaction25]
sql=SELECT (a.article_no || ';' || a.article_name || ';' || NVL(a.un_no, 'NULL') || ';UN_NO_RULE') AS result \
FROM ich21@zdev21_tcp:temp_article_master a \
WHERE a.un_no IS NOT NULL \
ORDER BY a.article_no;
header=article_no;article_name;un_no;rule_type

# Test medicine classification rule
[transaction26]
sql=SELECT (a.article_no || ';' || a.article_name || ';' || NVL(a.atc_code, 'EMPTY') || ';' || \
           a.homeopathy_flag || ';' || a.anthroposophic_flag || ';' || a.medicine_flag || ';MEDICINE_RULE') AS result \
FROM ich21@zdev21_tcp:temp_article_master a \
WHERE a.medicine_flag = 'Y' \
  AND (a.atc_code IS NULL OR a.atc_code = '') \
ORDER BY a.article_no;
header=article_no;article_name;atc_code;homeopathy_flag;anthroposophic_flag;medicine_flag;rule_type

# ==============================================================================
# PHASE 4: EXPORT PERMISSION CALCULATION
# ==============================================================================

# Initialize all articles as exportable
[transaction27]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportarticle \
SELECT article_no, 'DE', 10, 1, 20250101, 0 \
FROM ich21@zdev21_tcp:temp_article_master;

# Apply exclusion rules - update export permissions
[transaction28]
sql=UPDATE ich21@zdev21_tcp:temp_exportarticle \
SET export_permission_flag = 0, \
    change_counter = change_counter + 1, \
    last_update_date = 20250101 \
WHERE article_no IN ( \
    SELECT article_no FROM ich21@zdev21_tcp:temp_article_master \
    WHERE narcotics_flag = 1 \
       OR un_no IS NOT NULL \
       OR notifiable_flag = 1 \
       OR explosion_flag = 1 \
       OR psychotropic_flag = 1 \
       OR animal_medicine_flag = 1 \
       OR export_block_flag = 1 \
       OR biozid_flag = '1' \
       OR article_locked_flag = 'Y' \
       OR storage_location = 'RESTRICTED' \
       OR active_article_flag = 'N' \
       OR cool_article_mode = 'COLD_CHAIN' \
       OR distribution_binding_mode = 'RESTRICTED' \
       OR prismae_no IS NOT NULL \
       OR distribution_binding_ifa = 'IFA_RESTRICTED' \
);

# Apply medicine classification exclusion
[transaction29]
sql=UPDATE ich21@zdev21_tcp:temp_exportarticle \
SET export_permission_flag = 0, \
    change_counter = change_counter + 1 \
WHERE article_no IN ( \
    SELECT article_no FROM ich21@zdev21_tcp:temp_article_master \
    WHERE medicine_flag = 'Y' \
      AND (atc_code IS NULL OR atc_code = '') \
      AND homeopathy_flag != '1' \
      AND anthroposophic_flag != '1' \
);

# ==============================================================================
# PHASE 5: RESULTS VALIDATION AND REPORTING
# ==============================================================================

# Test final export permission results
[transaction30]
sql=SELECT (e.article_no || ';' || a.article_name || ';' || e.export_permission_flag || ';' || \
           CASE WHEN e.export_permission_flag = 0 THEN 'EXCLUDED' ELSE 'ALLOWED' END) AS result \
FROM ich21@zdev21_tcp:temp_exportarticle e, \
     ich21@zdev21_tcp:temp_article_master a \
WHERE e.article_no = a.article_no \
ORDER BY e.article_no;
header=article_no;article_name;export_flag;status

# Generate summary statistics
[transaction31]
sql=SELECT ('TOTAL_ARTICLES;' || COUNT(*) || ';Total articles processed') AS result \
FROM ich21@zdev21_tcp:temp_exportarticle \
UNION ALL \
SELECT ('ALLOWED_EXPORTS;' || COUNT(*) || ';Articles allowed for export') AS result \
FROM ich21@zdev21_tcp:temp_exportarticle \
WHERE export_permission_flag = 1 \
UNION ALL \
SELECT ('EXCLUDED_EXPORTS;' || COUNT(*) || ';Articles excluded from export') AS result \
FROM ich21@zdev21_tcp:temp_exportarticle \
WHERE export_permission_flag = 0;
header=metric;value;description

# Test date-based validations - simplified for Informix
[transaction32]
sql=SELECT (article_no || ';' || \
           CASE WHEN outsale_date > 0 THEN \
               CASE WHEN outsale_date < 20250101 THEN 'OUTSALE_PAST' ELSE 'OUTSALE_FUTURE' END \
           ELSE 'NO_OUTSALE' END || ';' || \
           CASE WHEN expiry_date > 0 THEN \
               CASE WHEN expiry_date < 20250131 THEN 'EXPIRY_SOON' ELSE 'EXPIRY_OK' END \
           ELSE 'NO_EXPIRY' END) AS result \
FROM ich21@zdev21_tcp:temp_article_master \
WHERE outsale_date IS NOT NULL OR expiry_date IS NOT NULL \
ORDER BY article_no;
header=article_no;outsale_status;expiry_status

# Test NULL value handling
[transaction33]
sql=SELECT ('NULL_HANDLING;' || \
           SUM(CASE WHEN atc_code IS NULL THEN 1 ELSE 0 END) || ';' || \
           SUM(CASE WHEN un_no IS NULL THEN 1 ELSE 0 END) || ';' || \
           SUM(CASE WHEN prismae_no IS NULL THEN 1 ELSE 0 END)) AS result \
FROM ich21@zdev21_tcp:temp_article_master;
header=check_type;null_atc_count;null_un_count;null_prismae_count

# Data integrity check
[transaction34]
sql=SELECT ('INTEGRITY_CHECK;' || \
           COUNT(DISTINCT a.article_no) || ';' || \
           COUNT(DISTINCT e.article_no) || ';' || \
           CASE WHEN COUNT(DISTINCT a.article_no) = COUNT(DISTINCT e.article_no) \
                THEN 'CONSISTENT' ELSE 'INCONSISTENT' END) AS result \
FROM ich21@zdev21_tcp:temp_article_master a \
LEFT JOIN ich21@zdev21_tcp:temp_exportarticle e ON a.article_no = e.article_no;
header=check_type;article_count;permission_count;status

# Rule coverage validation
[transaction35]
sql=SELECT (p.rule_id || ';' || p.rule_name || ';' || \
           CASE WHEN p.activation_flag = 1 THEN 'ACTIVE' ELSE 'INACTIVE' END || ';' || \
           'RULE_COVERAGE') AS result \
FROM ich21@zdev21_tcp:temp_exportexclusionparameter p \
WHERE p.country = 'DE' AND p.branchno = 10 \
ORDER BY p.rule_id;
header=rule_id;rule_name;status;check_type

# Final processing summary
[transaction36]
sql=SELECT ('PROCESSING_SUMMARY;' || \
           SUM(CASE WHEN export_permission_flag = 1 THEN 1 ELSE 0 END) || ';' || \
           SUM(CASE WHEN export_permission_flag = 0 THEN 1 ELSE 0 END) || ';' || \
           SUM(change_counter) || ';' || \
           'FINAL_RESULTS') AS result \
FROM ich21@zdev21_tcp:temp_exportarticle;
header=summary_type;allowed_count;excluded_count;total_changes;description

# ==============================================================================
# PHASE 6: PERFORMANCE AND COMPLEX QUERY TESTING
# ==============================================================================

# Test complex join performance
[transaction37]
sql=SELECT (a.article_no || ';' || a.article_name || ';' || a.manufacturer || ';' || \
           b.branchname || ';' || e.export_permission_flag) AS result \
FROM ich21@zdev21_tcp:temp_article_master a, \
     ich21@zdev21_tcp:temp_exportarticle e, \
     ich21@zdev21_tcp:temp_branch_info b \
WHERE a.article_no = e.article_no \
  AND e.branchno = b.branchno \
  AND e.country = 'DE' \
ORDER BY a.article_no \
FIRST 10;
header=article_no;article_name;manufacturer;branchname;export_flag

# Test aggregation performance
[transaction38]
sql=SELECT (b.country || ';' || COUNT(*) || ';' || \
           AVG(CASE WHEN e.export_permission_flag = 1 THEN 1.0 ELSE 0.0 END)) AS result \
FROM ich21@zdev21_tcp:temp_exportarticle e, \
     ich21@zdev21_tcp:temp_branch_info b \
WHERE e.branchno = b.branchno \
GROUP BY b.country \
ORDER BY COUNT(*) DESC;
header=country;total_articles;export_percentage

# ==============================================================================
# PHASE 7: CLEANUP - Drop temporary tables
# ==============================================================================

# Drop all temporary tables in reverse order
[transaction39]
sql=DROP TABLE ich21@zdev21_tcp:temp_processing_stats;

[transaction40]
sql=DROP TABLE ich21@zdev21_tcp:temp_exportarticle;

[transaction41]
sql=DROP TABLE ich21@zdev21_tcp:temp_article_master;

[transaction42]
sql=DROP TABLE ich21@zdev21_tcp:temp_branch_info;

[transaction43]
sql=DROP TABLE ich21@zdev21_tcp:temp_exportexclusionparameter;

# Final validation - check remaining temp tables
[transaction44]
sql=SELECT COUNT(*) AS remaining_temp_tables \
FROM systables \
WHERE tabname LIKE 'temp_%' \
  AND owner = USER;
header=remaining_temp_tables

# ==============================================================================
# END OF CONFIGURATION - TOTAL TRANSACTIONS: 45 (sequential numbering 00-44)
# ==============================================================================
