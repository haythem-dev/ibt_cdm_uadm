# ==============================================================================
# ESQLTEST Configuration for ExportArticleCalculator Module - Informix V14.10FC10 Upgrade Testing
# Module: pharmos.base.cdm/dev/src/batch/exportarticlecalculator
# Purpose: Comprehensive validation of export article calculation logic for Informix upgrade
# Target: Validate all 22 export exclusion rules and database compatibility
# Version: 1.0 - Enhanced for Informix V12.10FC10 to V14.10FC10 migration
# ==============================================================================

[general]
database=ich21@zdev21_tcp
test_capture_entries_count=10
persistent_connection=1
separator=;
timeout=600
commit_interval=100

# ==============================================================================
# PHASE 1: SETUP - Create comprehensive test environment
# ==============================================================================

# Create main export exclusion parameter table
[transaction00]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_exportexclusionparameter ( \
    country VARCHAR(3) NOT NULL, \
    branchno SMALLINT NOT NULL, \
    rule_id SMALLINT NOT NULL, \
    rule_name VARCHAR(50), \
    parameter_value VARCHAR(100), \
    activation_flag SMALLINT DEFAULT 1, \
    lastchangedatetime DATETIME YEAR TO SECOND DEFAULT CURRENT, \
    PRIMARY KEY (country, branchno, rule_id) \
);

# Create comprehensive article master data table
[transaction01]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_article_master ( \
    article_no INTEGER NOT NULL PRIMARY KEY, \
    article_name VARCHAR(80), \
    manufacturer VARCHAR(40), \
    atc_code VARCHAR(20), \
    narcotics_flag SMALLINT DEFAULT 0, \
    un_no VARCHAR(10), \
    notifiable_flag SMALLINT DEFAULT 0, \
    explosion_flag SMALLINT DEFAULT 0, \
    psychotropic_flag SMALLINT DEFAULT 0, \
    animal_medicine_flag SMALLINT DEFAULT 0, \
    narcotic_substance_flag SMALLINT DEFAULT 0, \
    distribution_binding_mode VARCHAR(20), \
    distribution_binding_ifa VARCHAR(20), \
    prismae_no INTEGER, \
    export_block_flag SMALLINT DEFAULT 0, \
    outsale_date INTEGER, \
    expiry_date INTEGER, \
    biozid_flag VARCHAR(1), \
    article_locked_flag VARCHAR(1), \
    storage_location VARCHAR(20), \
    active_article_flag VARCHAR(1) DEFAULT 'Y', \
    cool_article_mode VARCHAR(20), \
    hazardous_substance_old SMALLINT DEFAULT 0, \
    hazardous_substance_new SMALLINT DEFAULT 0, \
    homeopathy_flag VARCHAR(1) DEFAULT 'N', \
    anthroposophic_flag VARCHAR(1) DEFAULT 'N', \
    medicine_flag VARCHAR(1) DEFAULT 'N', \
    lastchangedatetime DATETIME YEAR TO SECOND DEFAULT CURRENT \
);

# Create export article permission tracking table
[transaction02]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_exportarticle ( \
    article_no INTEGER NOT NULL, \
    country VARCHAR(3) NOT NULL, \
    branchno SMALLINT NOT NULL, \
    export_permission_flag SMALLINT DEFAULT 1, \
    last_update_date INTEGER, \
    change_counter INTEGER DEFAULT 0, \
    PRIMARY KEY (article_no, country, branchno) \
);

# Create processing statistics table
[transaction03]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_processing_stats ( \
    stat_type VARCHAR(30), \
    rule_id SMALLINT, \
    rule_name VARCHAR(50), \
    article_count INTEGER, \
    exclusion_count INTEGER, \
    processed_count INTEGER DEFAULT 0, \
    description VARCHAR(100) \
);

# Create branch reference data
[transaction04]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_branch_info ( \
    branchno SMALLINT NOT NULL PRIMARY KEY, \
    branchname VARCHAR(40), \
    country VARCHAR(3), \
    region VARCHAR(20), \
    active_flag SMALLINT DEFAULT 1 \
);

# ==============================================================================
# PHASE 2: REFERENCE DATA SETUP - Load test exclusion parameters
# ==============================================================================

# Load branch information
[transaction05]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_info (branchno, branchname, country, region, active_flag) VALUES \
(10, 'Central Pharmacy Berlin', 'DE', 'North', 1);

[transaction06]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_info (branchno, branchname, country, region, active_flag) VALUES \
(20, 'Regional Pharmacy Munich', 'DE', 'South', 1);

[transaction07]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_info (branchno, branchname, country, region, active_flag) VALUES \
(30, 'Metro Pharmacy Vienna', 'AT', 'Central', 1);

# Load export exclusion parameters - All 22 rules
[transaction08]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 1, 'NARCOTICS', '1', 1);

[transaction09]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 2, 'UN_NO', 'NOT_NULL', 1);

[transaction10]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 3, 'NOTIFIABLE', '1', 1);

[transaction11]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 4, 'EXPLOSION', '1', 1);

[transaction12]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 5, 'PSYCHOTROPIC', '1', 1);

[transaction13]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 6, 'ANIMAL_MEDICINE', '1', 1);

[transaction14]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 7, 'ATC_CODE', 'NOT_NULL', 1);

[transaction15]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 8, 'NARCOTIC_SUBSTANCE', '1', 1);

[transaction16]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 9, 'MEDICINE', 'COMPLEX_RULE', 1);

[transaction17]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 10, 'DISTRIBUTION_RESTR', 'RESTRICTED', 1);

[transaction18]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 11, 'INTERNAL_ARTICLE', 'NOT_NULL', 1);

[transaction19]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 12, 'EXPORT_BLOCK', '1', 1);

[transaction20]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 13, 'OUTSALE', 'DATE_CHECK', 1);

[transaction21]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 14, 'EXPIRY', 'DATE_CHECK', 1);

[transaction22]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 15, 'BIOZID', '1', 1);

[transaction23]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 16, 'ARTICLE_LOCK', 'Y', 1);

[transaction24]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 17, 'STORAGE_LOCATION', 'RESTRICTED', 1);

[transaction25]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 18, 'ACTIVE_ARTICLE', 'N', 1);

[transaction26]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 19, 'COOL_ARTICLE', 'COLD_CHAIN', 1);

[transaction27]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 20, 'HAZARDOUS_OLD', '1', 1);

[transaction28]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 21, 'HAZARDOUS_NEW', '1', 1);

[transaction29]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportexclusionparameter \
(country, branchno, rule_id, rule_name, parameter_value, activation_flag) VALUES \
('DE', 10, 22, 'DISTRIBUTION_IFA', 'IFA_RESTRICTED', 1);

# ==============================================================================
# PHASE 3: COMPREHENSIVE ARTICLE DATA SETUP - Test scenarios for all rules
# ==============================================================================

# Article 1: Normal exportable article (baseline)
[transaction30]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, atc_code, active_article_flag, medicine_flag) VALUES \
(100001, 'Aspirin 100mg', 'Bayer AG', 'B01AC06', 'Y', 'Y');

# Article 2: Narcotics exclusion (Rule 1)
[transaction31]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, narcotics_flag, medicine_flag) VALUES \
(100002, 'Morphine 10mg', 'Pharma Corp', 1, 'Y');

# Article 3: UN Number exclusion (Rule 2)
[transaction32]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, un_no, medicine_flag) VALUES \
(100003, 'Ethanol Solution', 'Chemical Co', 'UN1170', 'N');

# Article 4: Notifiable substance (Rule 3)
[transaction33]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, notifiable_flag, medicine_flag) VALUES \
(100004, 'Radioactive Tracer', 'Nuclear Med', 1, 'Y');

# Article 5: Explosive material (Rule 4)
[transaction34]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, explosion_flag, medicine_flag) VALUES \
(100005, 'Nitroglycerin Tablets', 'CardioPharm', 1, 'Y');

# Article 6: Psychotropic substance (Rule 5)
[transaction35]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, psychotropic_flag, atc_code, medicine_flag) VALUES \
(100006, 'Diazepam 5mg', 'BenzoPharm', 1, 'N05BA01', 'Y');

# Article 7: Animal medicine (Rule 6)
[transaction36]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, animal_medicine_flag, medicine_flag) VALUES \
(100007, 'Veterinary Antibiotic', 'VetCorp', 1, 'Y');

# Article 8: Medicine without ATC (Rule 9 - complex rule test case 1)
[transaction37]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, atc_code, homeopathy_flag, anthroposophic_flag, medicine_flag) VALUES \
(100008, 'Unclassified Medicine', 'GenericPharm', '', 'N', 'N', 'Y');

# Article 9: Homeopathic medicine without ATC (Rule 9 - should NOT be excluded)
[transaction38]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, atc_code, homeopathy_flag, anthroposophic_flag, medicine_flag) VALUES \
(100009, 'Arnica Homeopathic', 'HomeoPharm', '', '1', 'N', 'Y');

# Article 10: Anthroposophic medicine without ATC (Rule 9 - should NOT be excluded)
[transaction39]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, atc_code, homeopathy_flag, anthroposophic_flag, medicine_flag) VALUES \
(100010, 'Anthroposophic Remedy', 'AnthroMed', '', 'N', '1', 'Y');

# Article 11: Distribution restriction (Rule 10)
[transaction40]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, distribution_binding_mode, medicine_flag) VALUES \
(100011, 'Restricted Distribution Drug', 'RestrictPharm', 'RESTRICTED', 'Y');

# Article 12: Internal article (Rule 11)
[transaction41]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, prismae_no, medicine_flag) VALUES \
(100012, 'Internal Test Product', 'InternalLab', 999999, 'Y');

# Article 13: Export blocked (Rule 12)
[transaction42]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, export_block_flag, medicine_flag) VALUES \
(100013, 'Export Blocked Medicine', 'BlockedPharm', 1, 'Y');

# Article 14: Outsale date restriction (Rule 13)
[transaction43]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, outsale_date, medicine_flag) VALUES \
(100014, 'Discontinued Medicine', 'OldPharm', 20240101, 'Y');

# Article 15: Expiry date restriction (Rule 14)
[transaction44]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, expiry_date, medicine_flag) VALUES \
(100015, 'Short Expiry Medicine', 'QuickExpiry', 20241231, 'Y');

# Article 16: Biocidal product (Rule 15)
[transaction45]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, biozid_flag, medicine_flag) VALUES \
(100016, 'Antiseptic Solution', 'BiocideCorp', '1', 'N');

# Article 17: Locked article (Rule 16)
[transaction46]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, article_locked_flag, medicine_flag) VALUES \
(100017, 'Locked for Export', 'SecurePharm', 'Y', 'Y');

# Article 18: Storage location restriction (Rule 17)
[transaction47]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, storage_location, medicine_flag) VALUES \
(100018, 'Special Storage Drug', 'StoragePharm', 'RESTRICTED', 'Y');

# Article 19: Inactive article (Rule 18)
[transaction48]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, active_article_flag, medicine_flag) VALUES \
(100019, 'Inactive Product', 'InactivePharm', 'N', 'Y');

# Article 20: Cold chain requirement (Rule 19)
[transaction49]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, cool_article_mode, medicine_flag) VALUES \
(100020, 'Refrigerated Vaccine', 'ColdPharm', 'COLD_CHAIN', 'Y');

# Article 21: Old hazardous classification (Rule 20)
[transaction50]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, hazardous_substance_old, medicine_flag) VALUES \
(100021, 'Legacy Hazardous Drug', 'OldHazard', 1, 'Y');

# Article 22: New hazardous classification (Rule 21)
[transaction51]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, hazardous_substance_new, medicine_flag) VALUES \
(100022, 'New Hazardous Classification', 'NewHazard', 1, 'Y');

# Article 23: IFA distribution restriction (Rule 22)
[transaction52]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, distribution_binding_ifa, medicine_flag) VALUES \
(100023, 'IFA Restricted Medicine', 'IFAPharm', 'IFA_RESTRICTED', 'Y');

# Article 24: Multiple exclusions test case
[transaction53]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
(article_no, article_name, manufacturer, narcotics_flag, psychotropic_flag, export_block_flag, medicine_flag) VALUES \
(100024, 'Multiple Exclusion Test', 'MultiExclude', 1, 1, 1, 'Y');

# ==============================================================================
# PHASE 4: EXCLUSION RULE VALIDATION - Test each rule individually
# ==============================================================================

# Validate parameter loading
[transaction54]
sql=SELECT (country || ';' || branchno || ';' || rule_id || ';' || rule_name || ';' || activation_flag) AS result \
FROM ich21@zdev21_tcp:temp_exportexclusionparameter \
WHERE country = 'DE' AND branchno = 10 \
ORDER BY rule_id;
header=country;branchno;rule_id;rule_name;activation_flag

# Test Rule 1: Narcotics exclusion
[transaction55]
sql=SELECT (a.article_no || ';' || a.article_name || ';' || a.narcotics_flag || ';NARCOTICS_RULE') AS result \
FROM ich21@zdev21_tcp:temp_article_master a, \
     ich21@zdev21_tcp:temp_exportexclusionparameter p \
WHERE p.rule_id = 1 AND p.activation_flag = 1 \
  AND a.narcotics_flag = CAST(p.parameter_value AS SMALLINT) \
ORDER BY a.article_no;
header=article_no;article_name;narcotics_flag;rule_type

# Test Rule 2: UN Number exclusion
[transaction56]
sql=SELECT (a.article_no || ';' || a.article_name || ';' || NVL(a.un_no, 'NULL') || ';UN_NO_RULE') AS result \
FROM ich21@zdev21_tcp:temp_article_master a, \
     ich21@zdev21_tcp:temp_exportexclusionparameter p \
WHERE p.rule_id = 2 AND p.activation_flag = 1 \
  AND a.un_no IS NOT NULL \
ORDER BY a.article_no;
header=article_no;article_name;un_no;rule_type

# Test Rule 9: Complex medicine exclusion logic
[transaction57]
sql=SELECT (a.article_no || ';' || a.article_name || ';' || NVL(a.atc_code, 'EMPTY') || ';' || \
           a.homeopathy_flag || ';' || a.anthroposophic_flag || ';' || a.medicine_flag || ';MEDICINE_RULE') AS result \
FROM ich21@zdev21_tcp:temp_article_master a \
WHERE a.medicine_flag = 'Y' \
  AND (a.atc_code IS NULL OR a.atc_code = '') \
ORDER BY a.article_no;
header=article_no;article_name;atc_code;homeopathy;anthroposophic;medicine;rule_type

# Calculate medicine exclusions (Rule 9 logic)
[transaction58]
sql=SELECT (a.article_no || ';' || \
           CASE WHEN (a.atc_code IS NULL OR a.atc_code = '') \
                AND a.homeopathy_flag != '1' \
                AND a.anthroposophic_flag != '1' \
                AND a.medicine_flag = 'Y' \
                THEN 'EXCLUDED' ELSE 'ALLOWED' END || ';MEDICINE_EXCLUSION_RESULT') AS result \
FROM ich21@zdev21_tcp:temp_article_master a \
WHERE a.medicine_flag = 'Y' \
ORDER BY a.article_no;
header=article_no;exclusion_result;rule_type

# ==============================================================================
# PHASE 5: COMPREHENSIVE EXCLUSION SIMULATION - Module logic simulation
# ==============================================================================

# Simulate complete exclusion calculation for each article
[transaction59]
sql=INSERT INTO ich21@zdev21_tcp:temp_processing_stats \
SELECT 'RULE_VALIDATION', p.rule_id, p.rule_name, \
       COUNT(DISTINCT a.article_no), \
       SUM(CASE \
           WHEN p.rule_id = 1 AND a.narcotics_flag = 1 THEN 1 \
           WHEN p.rule_id = 2 AND a.un_no IS NOT NULL THEN 1 \
           WHEN p.rule_id = 3 AND a.notifiable_flag = 1 THEN 1 \
           WHEN p.rule_id = 4 AND a.explosion_flag = 1 THEN 1 \
           WHEN p.rule_id = 5 AND a.psychotropic_flag = 1 THEN 1 \
           WHEN p.rule_id = 6 AND a.animal_medicine_flag = 1 THEN 1 \
           WHEN p.rule_id = 8 AND a.narcotic_substance_flag = 1 THEN 1 \
           WHEN p.rule_id = 10 AND a.distribution_binding_mode = 'RESTRICTED' THEN 1 \
           WHEN p.rule_id = 11 AND a.prismae_no IS NOT NULL THEN 1 \
           WHEN p.rule_id = 12 AND a.export_block_flag = 1 THEN 1 \
           WHEN p.rule_id = 15 AND a.biozid_flag = '1' THEN 1 \
           WHEN p.rule_id = 16 AND a.article_locked_flag = 'Y' THEN 1 \
           WHEN p.rule_id = 17 AND a.storage_location = 'RESTRICTED' THEN 1 \
           WHEN p.rule_id = 18 AND a.active_article_flag = 'N' THEN 1 \
           WHEN p.rule_id = 19 AND a.cool_article_mode = 'COLD_CHAIN' THEN 1 \
           WHEN p.rule_id = 20 AND a.hazardous_substance_old = 1 THEN 1 \
           WHEN p.rule_id = 21 AND a.hazardous_substance_new = 1 THEN 1 \
           WHEN p.rule_id = 22 AND a.distribution_binding_ifa = 'IFA_RESTRICTED' THEN 1 \
           ELSE 0 END), \
       0, \
       'Automatic rule validation count' \
FROM ich21@zdev21_tcp:temp_exportexclusionparameter p, \
     ich21@zdev21_tcp:temp_article_master a \
WHERE p.country = 'DE' AND p.branchno = 10 AND p.activation_flag = 1 \
GROUP BY p.rule_id, p.rule_name;

# Display rule validation statistics
[transaction60]
sql=SELECT (stat_type || ';' || rule_id || ';' || rule_name || ';' || article_count || ';' || exclusion_count) AS result \
FROM ich21@zdev21_tcp:temp_processing_stats \
WHERE stat_type = 'RULE_VALIDATION' \
ORDER BY rule_id;
header=stat_type;rule_id;rule_name;article_count;exclusion_count

# ==============================================================================
# PHASE 6: EXPORT PERMISSION CALCULATION - Simulate module's main logic
# ==============================================================================

# Initialize export permissions (default allow)
[transaction61]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportarticle \
SELECT article_no, 'DE', 10, 1, 20250101, 0 \
FROM ich21@zdev21_tcp:temp_article_master;

# Calculate final export permissions per article
[transaction62]
sql=UPDATE ich21@zdev21_tcp:temp_exportarticle \
SET export_permission_flag = CASE \
    WHEN EXISTS (SELECT 1 FROM ich21@zdev21_tcp:temp_article_master a \
                 WHERE a.article_no = temp_exportarticle.article_no \
                   AND (a.narcotics_flag = 1 OR a.un_no IS NOT NULL OR a.notifiable_flag = 1 \
                        OR a.explosion_flag = 1 OR a.psychotropic_flag = 1 OR a.animal_medicine_flag = 1 \
                        OR a.narcotic_substance_flag = 1 OR a.distribution_binding_mode = 'RESTRICTED' \
                        OR a.prismae_no IS NOT NULL OR a.export_block_flag = 1 \
                        OR a.biozid_flag = '1' OR a.article_locked_flag = 'Y' \
                        OR a.storage_location = 'RESTRICTED' OR a.active_article_flag = 'N' \
                        OR a.cool_article_mode = 'COLD_CHAIN' OR a.hazardous_substance_old = 1 \
                        OR a.hazardous_substance_new = 1 OR a.distribution_binding_ifa = 'IFA_RESTRICTED' \
                        OR (a.medicine_flag = 'Y' AND (a.atc_code IS NULL OR a.atc_code = '') \
                            AND a.homeopathy_flag != '1' AND a.anthroposophic_flag != '1'))) \
    THEN 0 ELSE 1 END, \
    change_counter = change_counter + 1, \
    last_update_date = 20250101;

# ==============================================================================
# PHASE 7: RESULTS VALIDATION - Verify calculation accuracy
# ==============================================================================

# Show export permission results
[transaction63]
sql=SELECT (e.article_no || ';' || a.article_name || ';' || e.export_permission_flag || ';' || \
           CASE WHEN e.export_permission_flag = 0 THEN 'EXCLUDED' ELSE 'ALLOWED' END) AS result \
FROM ich21@zdev21_tcp:temp_exportarticle e, \
     ich21@zdev21_tcp:temp_article_master a \
WHERE e.article_no = a.article_no \
ORDER BY e.article_no;
header=article_no;article_name;permission_flag;status

# Summary statistics
[transaction64]
sql=SELECT ('TOTAL_ARTICLES;' || COUNT(*) || ';Total articles processed') AS result \
FROM ich21@zdev21_tcp:temp_exportarticle \
UNION ALL \
SELECT ('ALLOWED_EXPORTS;' || COUNT(*) || ';Articles allowed for export') AS result \
FROM ich21@zdev21_tcp:temp_exportarticle WHERE export_permission_flag = 1 \
UNION ALL \
SELECT ('EXCLUDED_EXPORTS;' || COUNT(*) || ';Articles excluded from export') AS result \
FROM ich21@zdev21_tcp:temp_exportarticle WHERE export_permission_flag = 0;
header=metric;count;description

# ==============================================================================
# PHASE 8: INFORMIX COMPATIBILITY TESTING - Database-specific validations
# ==============================================================================

# Test date functions compatibility (Informix specific)
[transaction65]
sql=SELECT (article_no || ';' || \
           CASE WHEN outsale_date > 0 THEN \
               CASE WHEN outsale_date < TODAY THEN 'OUTSALE_PAST' ELSE 'OUTSALE_FUTURE' END \
           ELSE 'NO_OUTSALE' END || ';' || \
           CASE WHEN expiry_date > 0 THEN \
               CASE WHEN expiry_date < (TODAY + 30) THEN 'EXPIRY_SOON' ELSE 'EXPIRY_OK' END \
           ELSE 'NO_EXPIRY' END) AS result \
FROM ich21@zdev21_tcp:temp_article_master \
WHERE outsale_date IS NOT NULL OR expiry_date IS NOT NULL \
ORDER BY article_no;
header=article_no;outsale_status;expiry_status

# Test complex aggregation functions
[transaction66]
sql=SELECT (rule_id || ';' || COUNT(*) || ';' || \
           COUNT(DISTINCT article_no) || ';' || \
           ROUND(AVG(CASE WHEN exclusion_count > 0 THEN 1.0 ELSE 0.0 END) * 100, 2)) AS result \
FROM ich21@zdev21_tcp:temp_processing_stats \
WHERE stat_type = 'RULE_VALIDATION' \
GROUP BY rule_id \
HAVING COUNT(*) > 0 \
ORDER BY rule_id;
header=rule_id;total_validations;unique_articles;exclusion_percentage

# Test NULL handling consistency
[transaction67]
sql=SELECT ('NULL_HANDLING;' || \
           SUM(CASE WHEN atc_code IS NULL THEN 1 ELSE 0 END) || ';' || \
           SUM(CASE WHEN un_no IS NULL THEN 1 ELSE 0 END) || ';' || \
           SUM(CASE WHEN prismae_no IS NULL THEN 1 ELSE 0 END)) AS result \
FROM ich21@zdev21_tcp:temp_article_master;
header=test_type;null_atc_codes;null_un_numbers;null_prismae_numbers

# ==============================================================================
# PHASE 9: PERFORMANCE VALIDATION - Timing and resource tests
# ==============================================================================

# Large dataset simulation (create additional test data)
[transaction68]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_master \
SELECT (200000 + (MOD(rowid, 1000) + 1)), \
       ('Generated Article ' || (MOD(rowid, 1000) + 1)), \
       ('TestManufacturer' || (MOD(rowid, 10) + 1)), \
       CASE WHEN MOD(rowid, 5) = 0 THEN 'B01AC06' ELSE NULL END, \
       MOD(rowid, 7), \
       CASE WHEN MOD(rowid, 11) = 0 THEN 'UN1234' ELSE NULL END, \
       MOD(rowid, 13), \
       MOD(rowid, 17), \
       MOD(rowid, 19), \
       MOD(rowid, 23), \
       MOD(rowid, 29), \
       CASE WHEN MOD(rowid, 3) = 0 THEN 'RESTRICTED' ELSE 'NORMAL' END, \
       CASE WHEN MOD(rowid, 7) = 0 THEN 'IFA_RESTRICTED' ELSE 'NORMAL' END, \
       CASE WHEN MOD(rowid, 31) = 0 THEN 999999 ELSE NULL END, \
       MOD(rowid, 37), \
       CASE WHEN MOD(rowid, 41) = 0 THEN 20240101 ELSE NULL END, \
       CASE WHEN MOD(rowid, 43) = 0 THEN 20241231 ELSE NULL END, \
       CASE WHEN MOD(rowid, 47) = 0 THEN '1' ELSE '0' END, \
       CASE WHEN MOD(rowid, 53) = 0 THEN 'Y' ELSE 'N' END, \
       CASE WHEN MOD(rowid, 59) = 0 THEN 'RESTRICTED' ELSE 'NORMAL' END, \
       CASE WHEN MOD(rowid, 61) = 0 THEN 'N' ELSE 'Y' END, \
       CASE WHEN MOD(rowid, 67) = 0 THEN 'COLD_CHAIN' ELSE 'NORMAL' END, \
       MOD(rowid, 71), \
       MOD(rowid, 73), \
       CASE WHEN MOD(rowid, 79) = 0 THEN '1' ELSE 'N' END, \
       CASE WHEN MOD(rowid, 83) = 0 THEN '1' ELSE 'N' END, \
       'Y', \
       CURRENT \
FROM ich21@zdev21_tcp:temp_branch_info \
WHERE rowid <= 3;

# Performance test: large dataset processing
[transaction69]
sql=SELECT (COUNT(*) || ';PERFORMANCE_TEST_RECORDS') AS result \
FROM ich21@zdev21_tcp:temp_article_master \
WHERE article_no >= 200000;
header=count;test_type

# Complex join performance test
[transaction70]
sql=SELECT (COUNT(DISTINCT a.article_no) || ';' || \
           COUNT(DISTINCT p.rule_id) || ';' || \
           'COMPLEX_JOIN_TEST') AS result \
FROM ich21@zdev21_tcp:temp_article_master a, \
     ich21@zdev21_tcp:temp_exportexclusionparameter p \
WHERE p.country = 'DE' AND p.branchno = 10 AND p.activation_flag = 1;
header=unique_articles;active_rules;test_type

# ==============================================================================
# PHASE 10: ERROR HANDLING VALIDATION - Test edge cases
# ==============================================================================

# Test duplicate handling
[transaction71]
sql=INSERT INTO ich21@zdev21_tcp:temp_exportarticle \
SELECT article_no, 'DE', 10, 0, 20250102, 1 \
FROM ich21@zdev21_tcp:temp_article_master \
WHERE article_no = 100001;
# This should fail due to primary key constraint

# Test data type conversion
[transaction72]
sql=SELECT (article_no || ';' || \
           CASE WHEN narcotics_flag IS NOT NULL \
                THEN CAST(narcotics_flag AS VARCHAR(10)) \
                ELSE 'NULL' END || ';' || \
           'DATA_TYPE_TEST') AS result \
FROM ich21@zdev21_tcp:temp_article_master \
WHERE article_no BETWEEN 100001 AND 100005 \
ORDER BY article_no;
header=article_no;narcotics_flag_str;test_type

# ==============================================================================
# PHASE 11: FINAL VALIDATION - Comprehensive system check
# ==============================================================================

# Final data integrity check
[transaction73]
sql=SELECT ('INTEGRITY_CHECK;' || \
           COUNT(DISTINCT a.article_no) || ';' || \
           COUNT(DISTINCT e.article_no) || ';' || \
           CASE WHEN COUNT(DISTINCT a.article_no) = COUNT(DISTINCT e.article_no) \
                THEN 'CONSISTENT' ELSE 'INCONSISTENT' END) AS result \
FROM ich21@zdev21_tcp:temp_article_master a \
LEFT JOIN ich21@zdev21_tcp:temp_exportarticle e ON a.article_no = e.article_no;
header=check_type;master_count;export_count;consistency_status

# Rules coverage validation
[transaction74]
sql=SELECT (p.rule_id || ';' || p.rule_name || ';' || \
           CASE WHEN p.activation_flag = 1 THEN 'ACTIVE' ELSE 'INACTIVE' END || ';' || \
           'RULE_COVERAGE') AS result \
FROM ich21@zdev21_tcp:temp_exportexclusionparameter p \
WHERE p.country = 'DE' AND p.branchno = 10 \
ORDER BY p.rule_id;
header=rule_id;rule_name;status;test_type

# Processing summary
[transaction75]
sql=SELECT ('PROCESSING_SUMMARY;' || \
           SUM(CASE WHEN export_permission_flag = 1 THEN 1 ELSE 0 END) || ';' || \
           SUM(CASE WHEN export_permission_flag = 0 THEN 1 ELSE 0 END) || ';' || \
           SUM(change_counter) || ';' || \
           'FINAL_RESULTS') AS result \
FROM ich21@zdev21_tcp:temp_exportarticle;
header=summary_type;allowed_count;excluded_count;total_changes;result_type

# ==============================================================================
# PHASE 12: CLEANUP - Remove temporary tables
# ==============================================================================

# Drop all temporary tables
[transaction76]
sql=DROP TABLE ich21@zdev21_tcp:temp_exportexclusionparameter;

[transaction77]
sql=DROP TABLE ich21@zdev21_tcp:temp_article_master;

[transaction78]
sql=DROP TABLE ich21@zdev21_tcp:temp_exportarticle;

[transaction79]
sql=DROP TABLE ich21@zdev21_tcp:temp_processing_stats;

[transaction80]
sql=DROP TABLE ich21@zdev21_tcp:temp_branch_info;

# Final validation - ensure cleanup completed
[transaction81]
sql=SELECT COUNT(*) AS remaining_temp_tables \
FROM systables \
WHERE tabname LIKE 'temp_%' \
  AND owner = USER;
header=remaining_temp_tables

# ==============================================================================
# END OF CONFIGURATION
# Total Transactions: 82 (00-81)
# 
# Test Coverage:
# - All 22 export exclusion rules individually tested
# - Complex rule logic (medicine exclusion) thoroughly validated
# - Database compatibility for Informix V14.10FC10 upgrade
# - Performance testing with larger datasets
# - Error handling and edge case validation
# - Data integrity and consistency checks
# - Comprehensive cleanup and validation
# ==============================================================================