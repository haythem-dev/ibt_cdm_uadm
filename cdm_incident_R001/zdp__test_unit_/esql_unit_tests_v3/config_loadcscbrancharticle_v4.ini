
# ==============================================================================
# LoadCSCBranchArticle Module Validation Configuration - VERSION 5
# esqltest Framework Configuration File - INFORMIX SINGLE CONNECTION
# 
# Module: pharmos.outbound.csc_load/dev/src/loadcscbrancharticle
# Purpose: Validate branch article data loading from inbound to outbound DB
# Author: AI Assistant  
# Date: 2025-01-29
# Version: 5.0 (Permission-Fixed Temporary Tables Approach)
# ==============================================================================

[general]
database=ich21@zdev21_tcp
test_capture_entries_count=10
keepDBConnection=1
separator=;
timeout=300
commit_interval=1

# ==============================================================================
# PHASE 1: CLEANUP AND SETUP - Temporary tables only
# ==============================================================================

# Clean up any existing temporary tables first
[transaction00]
sql=DROP TABLE IF EXISTS temp_artikelf_source;

[transaction01]
sql=DROP TABLE IF EXISTS temp_cscbrancharticle;

[transaction02]
sql=DROP TABLE IF EXISTS temp_processing_artikelf;

[transaction03]
sql=DROP TABLE IF EXISTS temp_branch_reference;

[transaction04]
sql=DROP TABLE IF EXISTS temp_validation_results;

# Create source table (simulates inbound artikelf) - TEMP TABLE
[transaction05]
sql=CREATE TEMP TABLE temp_artikelf_source ( \
    filialnr INTEGER NOT NULL, \
    artikel_nr INTEGER NOT NULL, \
    besla_nr INTEGER, \
    bestand_min INTEGER, \
    artikelaktiv CHAR(1), \
    lagerfachnr CHAR(10), \
    offene_bestmenge INTEGER, \
    datum_aender INTEGER NOT NULL, \
    openorderqty_noteffective INTEGER, \
    PRIMARY KEY (filialnr, artikel_nr) \
);

# Create target table (simulates cscbrancharticle) - TEMP TABLE
[transaction06]
sql=CREATE TEMP TABLE temp_cscbrancharticle ( \
    filialnr INTEGER NOT NULL, \
    artikel_nr INTEGER NOT NULL, \
    besla_nr INTEGER, \
    bestand_min INTEGER, \
    artikelaktiv CHAR(1), \
    lagerfachnr CHAR(10), \
    offene_bestmenge INTEGER, \
    openorderqty_noteffective INTEGER, \
    lastupdatedate INTEGER DEFAULT 0, \
    PRIMARY KEY (filialnr, artikel_nr) \
);

# Create processing table (simulates tmp_artikelf) - TEMP TABLE
[transaction07]
sql=CREATE TEMP TABLE temp_processing_artikelf ( \
    filialnr INTEGER, \
    artikel_nr INTEGER, \
    besla_nr INTEGER, \
    bestand_min INTEGER, \
    artikelaktiv CHAR(1), \
    lagerfachnr CHAR(10), \
    offene_bestmenge INTEGER, \
    datum_aender INTEGER, \
    openorderqty_noteffective INTEGER \
);

# Create branch reference data - TEMP TABLE
[transaction08]
sql=CREATE TEMP TABLE temp_branch_reference ( \
    filialnr INTEGER NOT NULL PRIMARY KEY, \
    branchname VARCHAR(40), \
    region VARCHAR(20), \
    active_flag INTEGER DEFAULT 1 \
);

# Create validation results table - TEMP TABLE
[transaction09]
sql=CREATE TEMP TABLE temp_validation_results ( \
    validation_type VARCHAR(50), \
    metric_name VARCHAR(50), \
    metric_value INTEGER, \
    description VARCHAR(100) \
);

# ==============================================================================
# PHASE 2: REFERENCE DATA LOADING - Single INSERT operations
# ==============================================================================

# Load branch reference data
[transaction10]
sql=INSERT INTO temp_branch_reference (filialnr, branchname, region, active_flag) VALUES (10, 'Central Branch Berlin', 'North', 1);

[transaction11]
sql=INSERT INTO temp_branch_reference (filialnr, branchname, region, active_flag) VALUES (20, 'Regional Branch Munich', 'South', 1);

[transaction12]
sql=INSERT INTO temp_branch_reference (filialnr, branchname, region, active_flag) VALUES (30, 'Metro Branch Vienna', 'Central', 1);

# Load initial historical data in target table
[transaction13]
sql=INSERT INTO temp_cscbrancharticle (filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, openorderqty_noteffective, lastupdatedate) VALUES (10, 100001, 501, 25, 'Y', 'A001', 150, 75, 20250125);

[transaction14]
sql=INSERT INTO temp_cscbrancharticle (filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, openorderqty_noteffective, lastupdatedate) VALUES (10, 100002, 502, 30, 'Y', 'A002', 200, 100, 20250125);

[transaction15]
sql=INSERT INTO temp_cscbrancharticle (filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, openorderqty_noteffective, lastupdatedate) VALUES (20, 100001, 503, 20, 'Y', 'B001', 180, 90, 20250125);

# Load source data (simulates inbound artikelf)
[transaction16]
sql=INSERT INTO temp_artikelf_source (filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective) VALUES (10, 100001, 501, 30, 'Y', 'A001', 175, 20250126, 80);

[transaction17]
sql=INSERT INTO temp_artikelf_source (filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective) VALUES (10, 100003, 504, 15, 'Y', 'A003', 120, 20250126, 60);

[transaction18]
sql=INSERT INTO temp_artikelf_source (filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective) VALUES (30, 100001, 505, 25, 'Y', 'C001', 160, 20250126, 85);

# ==============================================================================
# PHASE 3: BASIC QUERY VALIDATION - Test core operations
# ==============================================================================

# Test data validation - count records (Using Informix string concatenation)
[transaction19]
sql=SELECT (COUNT(*) || ';TOTAL_BRANCH_RECORDS') AS result FROM temp_branch_reference;
header=count;description

[transaction20]
sql=SELECT (COUNT(*) || ';TOTAL_SOURCE_RECORDS') AS result FROM temp_artikelf_source;
header=count;description

[transaction21]
sql=SELECT (COUNT(*) || ';TOTAL_TARGET_RECORDS') AS result FROM temp_cscbrancharticle;
header=count;description

# ==============================================================================
# PHASE 4: INCREMENTAL LOADING SIMULATION
# ==============================================================================

# Test incremental data selection (using NVL for NULL handling)
[transaction22]
sql=SELECT (s.filialnr || ';' || s.artikel_nr || ';' || NVL(s.besla_nr, 0) || ';' || NVL(s.bestand_min, 0) || ';' || NVL(s.artikelaktiv, 'N') || ';' || NVL(s.lagerfachnr, 'NONE') || ';' || NVL(s.offene_bestmenge, 0) || ';' || s.datum_aender || ';' || NVL(s.openorderqty_noteffective, 0)) AS result \
FROM temp_artikelf_source s \
WHERE s.filialnr = 10 \
  AND s.datum_aender >= (SELECT NVL(MAX(lastupdatedate), 0) FROM temp_cscbrancharticle WHERE filialnr = 10) \
ORDER BY s.artikel_nr;
header=filialnr;artikel_nr;besla_nr;bestand_min;artikelaktiv;lagerfachnr;offene_bestmenge;datum_aender;openorderqty_noteffective

# Clear processing table
[transaction23]
sql=DELETE FROM temp_processing_artikelf;

# Load processing table
[transaction24]
sql=INSERT INTO temp_processing_artikelf \
SELECT filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective \
FROM temp_artikelf_source \
WHERE filialnr = 10 \
  AND datum_aender >= (SELECT NVL(MAX(lastupdatedate), 0) FROM temp_cscbrancharticle WHERE filialnr = 10);

# Validate processing table load
[transaction25]
sql=SELECT (COUNT(*) || ';PROCESSING_RECORDS_LOADED') AS result FROM temp_processing_artikelf;
header=count;description

# ==============================================================================
# PHASE 5: MERGE OPERATIONS (Using MERGE statement)
# ==============================================================================

# Execute MERGE operation (UPDATE existing, INSERT new)
[transaction26]
sql=MERGE INTO temp_cscbrancharticle AS cba \
USING temp_processing_artikelf AS taf \
ON cba.filialnr = taf.filialnr AND cba.artikel_nr = taf.artikel_nr \
WHEN MATCHED THEN \
  UPDATE SET cba.besla_nr = taf.besla_nr, \
             cba.bestand_min = taf.bestand_min, \
             cba.artikelaktiv = taf.artikelaktiv, \
             cba.lagerfachnr = taf.lagerfachnr, \
             cba.offene_bestmenge = taf.offene_bestmenge, \
             cba.openorderqty_noteffective = taf.openorderqty_noteffective, \
             cba.lastupdatedate = 20250126 \
WHEN NOT MATCHED THEN \
  INSERT (filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, openorderqty_noteffective, lastupdatedate) \
  VALUES (taf.filialnr, taf.artikel_nr, taf.besla_nr, taf.bestand_min, taf.artikelaktiv, taf.lagerfachnr, taf.offene_bestmenge, taf.openorderqty_noteffective, 20250126);

# Record update statistics
[transaction27]
sql=INSERT INTO temp_validation_results SELECT 'MERGE_SUMMARY', 'updated_today', COUNT(*), 'Records updated today' FROM temp_cscbrancharticle WHERE lastupdatedate = 20250126;

[transaction28]
sql=INSERT INTO temp_validation_results SELECT 'MERGE_SUMMARY', 'total_records', COUNT(*), 'Total records in table' FROM temp_cscbrancharticle;

# Display results
[transaction29]
sql=SELECT (validation_type || ';' || metric_name || ';' || metric_value || ';' || description) AS result FROM temp_validation_results WHERE validation_type = 'MERGE_SUMMARY' ORDER BY metric_name;
header=operation;metric;value;description

# ==============================================================================
# PHASE 6: VALIDATION QUERIES
# ==============================================================================

# Test record-level validation after MERGE
[transaction30]
sql=SELECT (cba.filialnr || ';' || cba.artikel_nr || ';' || NVL(cba.besla_nr, 0) || ';' || NVL(cba.bestand_min, 0) || ';' || NVL(cba.artikelaktiv, 'N') || ';' || NVL(cba.lagerfachnr, 'NONE') || ';' || NVL(cba.offene_bestmenge, 0) || ';' || NVL(cba.openorderqty_noteffective, 0) || ';' || cba.lastupdatedate) AS result \
FROM temp_cscbrancharticle cba \
WHERE cba.filialnr = 10 AND cba.lastupdatedate = 20250126 \
ORDER BY cba.artikel_nr;
header=filialnr;artikel_nr;besla_nr;bestand_min;artikelaktiv;lagerfachnr;offene_bestmenge;openorderqty_noteffective;lastupdatedate

# Test multi-branch processing results
[transaction31]
sql=SELECT (br.branchname || ';' || COUNT(cba.artikel_nr) || ';' || AVG(cba.bestand_min) || ';' || MAX(cba.lastupdatedate)) AS result \
FROM temp_cscbrancharticle cba, temp_branch_reference br \
WHERE cba.filialnr = br.filialnr \
GROUP BY br.filialnr, br.branchname \
ORDER BY COUNT(cba.artikel_nr) DESC;
header=branchname;article_count;avg_min_stock;last_update

# Test article activity status distribution
[transaction32]
sql=SELECT (NVL(artikelaktiv, 'NULL') || ';' || COUNT(*) || ';ACTIVITY_STATUS') AS result \
FROM temp_cscbrancharticle \
GROUP BY artikelaktiv \
ORDER BY artikelaktiv;
header=status;count;description

# ==============================================================================
# PHASE 7: BATCH PROCESSING SIMULATION
# ==============================================================================

# Add more test data for batch processing
[transaction33]
sql=INSERT INTO temp_artikelf_source (filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective) VALUES (20, 100010, 510, 15, 'Y', 'B010', 110, 20250127, 55);

[transaction34]
sql=INSERT INTO temp_artikelf_source (filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective) VALUES (20, 100011, 511, 20, 'Y', 'B011', 130, 20250127, 65);

[transaction35]
sql=INSERT INTO temp_artikelf_source (filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective) VALUES (20, 100012, 512, 25, 'Y', 'B012', 150, 20250127, 75);

# Clear and reload processing table for branch 20
[transaction36]
sql=DELETE FROM temp_processing_artikelf;

[transaction37]
sql=INSERT INTO temp_processing_artikelf \
SELECT filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective \
FROM temp_artikelf_source \
WHERE filialnr = 20 AND datum_aender >= (SELECT NVL(MAX(lastupdatedate), 0) FROM temp_cscbrancharticle WHERE filialnr = 20);

# Execute batch MERGE for branch 20
[transaction38]
sql=MERGE INTO temp_cscbrancharticle AS cba \
USING temp_processing_artikelf AS taf \
ON cba.filialnr = taf.filialnr AND cba.artikel_nr = taf.artikel_nr \
WHEN MATCHED THEN \
  UPDATE SET cba.besla_nr = taf.besla_nr, \
             cba.bestand_min = taf.bestand_min, \
             cba.artikelaktiv = taf.artikelaktiv, \
             cba.lagerfachnr = taf.lagerfachnr, \
             cba.offene_bestmenge = taf.offene_bestmenge, \
             cba.openorderqty_noteffective = taf.openorderqty_noteffective, \
             cba.lastupdatedate = 20250127 \
WHEN NOT MATCHED THEN \
  INSERT (filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, openorderqty_noteffective, lastupdatedate) \
  VALUES (taf.filialnr, taf.artikel_nr, taf.besla_nr, taf.bestand_min, taf.artikelaktiv, taf.lagerfachnr, taf.offene_bestmenge, taf.openorderqty_noteffective, 20250127);

# ==============================================================================
# PHASE 8: DATA QUALITY CHECKS
# ==============================================================================

# Data quality checks - one at a time
[transaction39]
sql=INSERT INTO temp_validation_results SELECT 'DATA_QUALITY', 'null_besla_nr', COUNT(*), 'Records with NULL besla_nr' FROM temp_cscbrancharticle WHERE besla_nr IS NULL;

[transaction40]
sql=INSERT INTO temp_validation_results SELECT 'DATA_QUALITY', 'negative_bestand_min', COUNT(*), 'Records with negative bestand_min' FROM temp_cscbrancharticle WHERE bestand_min < 0;

[transaction41]
sql=INSERT INTO temp_validation_results SELECT 'DATA_QUALITY', 'inactive_articles', COUNT(*), 'Records with inactive articles' FROM temp_cscbrancharticle WHERE artikelaktiv = 'N';

# Display data quality results
[transaction42]
sql=SELECT (validation_type || ';' || metric_name || ';' || metric_value || ';' || description) AS result FROM temp_validation_results WHERE validation_type = 'DATA_QUALITY' ORDER BY metric_name;
header=check_type;metric;value;description

# ==============================================================================
# PHASE 9: FINAL VALIDATION
# ==============================================================================

# Final validation metrics - one at a time
[transaction43]
sql=INSERT INTO temp_validation_results SELECT 'FINAL_VALIDATION', 'total_records', COUNT(*), 'Total records in final table' FROM temp_cscbrancharticle;

[transaction44]
sql=INSERT INTO temp_validation_results SELECT 'FINAL_VALIDATION', 'unique_branches', COUNT(DISTINCT filialnr), 'Number of unique branches' FROM temp_cscbrancharticle;

[transaction45]
sql=INSERT INTO temp_validation_results SELECT 'FINAL_VALIDATION', 'unique_articles', COUNT(DISTINCT artikel_nr), 'Number of unique articles' FROM temp_cscbrancharticle;

[transaction46]
sql=INSERT INTO temp_validation_results SELECT 'FINAL_VALIDATION', 'recent_updates', COUNT(*), 'Records updated since 20250126' FROM temp_cscbrancharticle WHERE lastupdatedate >= 20250126;

# Display final validation results
[transaction47]
sql=SELECT (validation_type || ';' || metric_name || ';' || metric_value || ';' || description) AS result FROM temp_validation_results WHERE validation_type = 'FINAL_VALIDATION' ORDER BY metric_name;
header=validation_type;metric;value;description

# Final summary report
[transaction48]
sql=SELECT (cba.filialnr || ';' || COUNT(*) || ';' || COUNT(CASE WHEN cba.artikelaktiv = 'Y' THEN 1 END) || ';' || COUNT(CASE WHEN cba.bestand_min > 0 THEN 1 END)) AS result \
FROM temp_cscbrancharticle cba \
GROUP BY cba.filialnr \
HAVING COUNT(*) > 0 \
ORDER BY cba.filialnr;
header=filialnr;total_records;active_articles;positive_stock

# ==============================================================================
# PHASE 10: CLEANUP
# ==============================================================================

# Clean up temporary tables - one at a time
[transaction49]
sql=DROP TABLE temp_artikelf_source;

[transaction50]
sql=DROP TABLE temp_cscbrancharticle;

[transaction51]
sql=DROP TABLE temp_processing_artikelf;

[transaction52]
sql=DROP TABLE temp_branch_reference;

[transaction53]
sql=DROP TABLE temp_validation_results;

# Final verification
[transaction54]
sql=SELECT (COUNT(*) || ';REMAINING_TEMP_TABLES') AS result FROM systables WHERE tabname LIKE 'temp_%';
header=count;description

# ==============================================================================
# END OF CONFIGURATION
# ==============================================================================
