# ==============================================================================
# ESQLTEST Configuration for LoadBranchArticleConfig Module Validation - FIXED VERSION
# Module: pharmos.outbound.csc_load/dev/src/loadbrancharticleconfig
# Purpose: Comprehensive validation of IBT branch article configuration loading
# Changes: Fixed Informix database compatibility issues identified in exec01 analysis
# ==============================================================================

[general]
database=ich21@zdev21_tcp
test_capture_entries_count=10
persistent_connection=1
separator=;
timeout=300
commit_interval=50

# ==============================================================================
# PHASE 1: SETUP - Create temporary tables and reference data
# ==============================================================================

# Create main IBT branch article configuration table
[transaction00]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_ibtbrancharticleconfig ( \
    articleno INT NOT NULL, \
    branchno SMALLINT NOT NULL, \
    ibttypeid SMALLINT, \
    ibtassortmenttypeid SMALLINT, \
    ibtonlyflag SMALLINT DEFAULT 0, \
    lastchangedatetime DATETIME YEAR TO SECOND, \
    PRIMARY KEY (articleno, branchno) \
);

# Create processing/staging table
[transaction01]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_puibtbrancharticleconfig ( \
    ARTICLENO INT NOT NULL, \
    BRANCHNO SMALLINT NOT NULL, \
    IBTROLETYPEID SMALLINT, \
    ASSORTMENTTYPEID SMALLINT, \
    LASTCHANGEDATETIME DATETIME YEAR TO SECOND, \
    RELEVANCEFLAG SMALLINT DEFAULT 1, \
    PRIMARY KEY (ARTICLENO, BRANCHNO) \
);

# Create article reference table for testing
[transaction02]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_article_reference ( \
    articleno INT NOT NULL PRIMARY KEY, \
    articlename VARCHAR(80), \
    manufacturer VARCHAR(40), \
    active_flag SMALLINT DEFAULT 1 \
);

# Create branch reference table for testing
[transaction03]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_branch_reference ( \
    branchno SMALLINT NOT NULL PRIMARY KEY, \
    branchname VARCHAR(40), \
    country VARCHAR(20), \
    region VARCHAR(20) \
);

# Insert reference article data - FIXED: Split multi-row INSERT into individual statements
[transaction04a]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_reference (articleno, articlename, manufacturer, active_flag) \
VALUES (100001, 'Ibuprofen 400mg', 'Bayer AG', 1);

[transaction04b]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_reference (articleno, articlename, manufacturer, active_flag) \
VALUES (100002, 'Paracetamol 500mg', 'Pfizer Inc.', 1);

[transaction04c]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_reference (articleno, articlename, manufacturer, active_flag) \
VALUES (100003, 'Aspirin 100mg', 'Bayer AG', 1);

[transaction04d]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_reference (articleno, articlename, manufacturer, active_flag) \
VALUES (100004, 'Vitamin D3 1000IU', 'Novartis', 1);

[transaction04e]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_reference (articleno, articlename, manufacturer, active_flag) \
VALUES (100005, 'Omega-3 Fish Oil', 'Abbott', 1);

[transaction04f]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_reference (articleno, articlename, manufacturer, active_flag) \
VALUES (100006, 'Calcium 600mg', 'GSK', 1);

[transaction04g]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_reference (articleno, articlename, manufacturer, active_flag) \
VALUES (100007, 'Zinc 15mg', 'Roche', 1);

[transaction04h]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_reference (articleno, articlename, manufacturer, active_flag) \
VALUES (100008, 'Iron 65mg', 'Merck', 1);

[transaction04i]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_reference (articleno, articlename, manufacturer, active_flag) \
VALUES (100009, 'Magnesium 400mg', 'Teva', 1);

[transaction04j]
sql=INSERT INTO ich21@zdev21_tcp:temp_article_reference (articleno, articlename, manufacturer, active_flag) \
VALUES (100010, 'Multivitamin Complex', 'Sandoz', 1);

# Insert reference branch data - FIXED: Split multi-row INSERT into individual statements
[transaction05a]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_reference (branchno, branchname, country, region) \
VALUES (10, 'Central Pharmacy Berlin', 'Germany', 'North');

[transaction05b]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_reference (branchno, branchname, country, region) \
VALUES (20, 'Regional Pharmacy Munich', 'Germany', 'South');

[transaction05c]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_reference (branchno, branchname, country, region) \
VALUES (30, 'Metro Pharmacy Vienna', 'Austria', 'Central');

[transaction05d]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_reference (branchno, branchname, country, region) \
VALUES (40, 'City Pharmacy Zurich', 'Switzerland', 'North');

[transaction05e]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_reference (branchno, branchname, country, region) \
VALUES (50, 'District Pharmacy Prague', 'Czech Republic', 'Central');

# ==============================================================================
# PHASE 2: CORE FUNCTIONALITY TESTING - Basic IBT configuration operations
# ==============================================================================

# UC1: Test basic article-branch configuration insertion - FIXED: Split multi-row INSERT
[transaction06a]
sql=INSERT INTO ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
(articleno, branchno, ibttypeid, ibtassortmenttypeid, ibtonlyflag, lastchangedatetime) \
VALUES (100001, 10, 1, 1, 0, CURRENT);

[transaction06b]
sql=INSERT INTO ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
(articleno, branchno, ibttypeid, ibtassortmenttypeid, ibtonlyflag, lastchangedatetime) \
VALUES (100001, 20, 1, 1, 0, CURRENT);

[transaction06c]
sql=INSERT INTO ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
(articleno, branchno, ibttypeid, ibtassortmenttypeid, ibtonlyflag, lastchangedatetime) \
VALUES (100001, 30, 2, 1, 1, CURRENT);

[transaction06d]
sql=INSERT INTO ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
(articleno, branchno, ibttypeid, ibtassortmenttypeid, ibtonlyflag, lastchangedatetime) \
VALUES (100002, 10, 1, 2, 0, CURRENT);

[transaction06e]
sql=INSERT INTO ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
(articleno, branchno, ibttypeid, ibtassortmenttypeid, ibtonlyflag, lastchangedatetime) \
VALUES (100002, 20, 1, 2, 0, CURRENT);

# UC2: Test processing table data insertion - FIXED: Split multi-row INSERT
[transaction07a]
sql=INSERT INTO ich21@zdev21_tcp:temp_puibtbrancharticleconfig \
(ARTICLENO, BRANCHNO, IBTROLETYPEID, ASSORTMENTTYPEID, LASTCHANGEDATETIME, RELEVANCEFLAG) \
VALUES (100003, 10, 1, 1, CURRENT, 1);

[transaction07b]
sql=INSERT INTO ich21@zdev21_tcp:temp_puibtbrancharticleconfig \
(ARTICLENO, BRANCHNO, IBTROLETYPEID, ASSORTMENTTYPEID, LASTCHANGEDATETIME, RELEVANCEFLAG) \
VALUES (100003, 20, 2, 1, CURRENT, 1);

[transaction07c]
sql=INSERT INTO ich21@zdev21_tcp:temp_puibtbrancharticleconfig \
(ARTICLENO, BRANCHNO, IBTROLETYPEID, ASSORTMENTTYPEID, LASTCHANGEDATETIME, RELEVANCEFLAG) \
VALUES (100003, 30, 1, 2, CURRENT, 0);

[transaction07d]
sql=INSERT INTO ich21@zdev21_tcp:temp_puibtbrancharticleconfig \
(ARTICLENO, BRANCHNO, IBTROLETYPEID, ASSORTMENTTYPEID, LASTCHANGEDATETIME, RELEVANCEFLAG) \
VALUES (100004, 40, 1, 1, CURRENT, 1);

[transaction07e]
sql=INSERT INTO ich21@zdev21_tcp:temp_puibtbrancharticleconfig \
(ARTICLENO, BRANCHNO, IBTROLETYPEID, ASSORTMENTTYPEID, LASTCHANGEDATETIME, RELEVANCEFLAG) \
VALUES (100004, 50, 2, 2, CURRENT, 1);

# Validate insertion counts
[transaction08]
sql=SELECT (COUNT(*) || ';IBT_CONFIG') AS result FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
UNION ALL \
SELECT (COUNT(*) || ';PUIBT_CONFIG') AS result FROM ich21@zdev21_tcp:temp_puibtbrancharticleconfig;
header=count;table_type

# ==============================================================================
# PHASE 3: BRANCH-SPECIFIC PROCESSING - Test branch filtering and management
# ==============================================================================

# UC3: Test branch-specific article retrieval
[transaction09]
sql=SELECT (i.articleno || ';' || i.branchno || ';' || a.articlename || ';' || b.branchname) AS result \
FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig i, \
     ich21@zdev21_tcp:temp_article_reference a, \
     ich21@zdev21_tcp:temp_branch_reference b \
WHERE i.articleno = a.articleno \
  AND i.branchno = b.branchno \
  AND i.branchno = 10 \
ORDER BY i.articleno;
header=articleno;branchno;articlename;branchname

# UC4: Test IBT type filtering
[transaction10]
sql=SELECT (i.articleno || ';' || i.branchno || ';' || i.ibttypeid || ';' || i.ibtassortmenttypeid || ';' || i.ibtonlyflag) AS result \
FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig i \
WHERE i.ibttypeid = 1 \
ORDER BY i.articleno, i.branchno;
header=articleno;branchno;ibttypeid;assortmenttype;ibtonlyflag

# ==============================================================================
# PHASE 4: DATA SYNCHRONIZATION - Test PUIBT to IBT data flow
# ==============================================================================

# UC5: Simulate data transformation from PUIBT to IBT format
[transaction11]
sql=INSERT INTO ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
(articleno, branchno, ibttypeid, ibtassortmenttypeid, ibtonlyflag, lastchangedatetime) \
SELECT p.ARTICLENO, p.BRANCHNO, p.IBTROLETYPEID, p.ASSORTMENTTYPEID, \
       CASE WHEN p.RELEVANCEFLAG = 1 THEN 0 ELSE 1 END, p.LASTCHANGEDATETIME \
FROM ich21@zdev21_tcp:temp_puibtbrancharticleconfig p \
WHERE NOT EXISTS (SELECT 1 FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig i \
                  WHERE i.articleno = p.ARTICLENO AND i.branchno = p.BRANCHNO);

# Validate synchronization results
[transaction12]
sql=SELECT (COUNT(*) || ';TOTAL_CONFIGS_AFTER_SYNC') AS result \
FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig;
header=count;description

# ==============================================================================
# PHASE 5: UPDATE OPERATIONS - Test configuration updates
# ==============================================================================

# UC6: Test IBT flag updates (simulate WAFO type updates)
[transaction13]
sql=UPDATE ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
SET ibtonlyflag = 1, lastchangedatetime = CURRENT \
WHERE branchno IN (20, 30) AND articleno BETWEEN 100001 AND 100003;

# UC7: Test assortment type updates
[transaction14]
sql=UPDATE ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
SET ibtassortmenttypeid = 3, lastchangedatetime = CURRENT \
WHERE ibttypeid = 2;

# Validate update results
[transaction15]
sql=SELECT (articleno || ';' || branchno || ';' || ibtonlyflag || ';' || ibtassortmenttypeid) AS result \
FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
WHERE lastchangedatetime >= TODAY \
ORDER BY articleno, branchno;
header=articleno;branchno;ibtonlyflag;assortmenttype

# ==============================================================================
# PHASE 6: BATCH PROCESSING - Test large dataset handling
# ==============================================================================

# UC8: Create larger dataset for batch processing test
[transaction16]
sql=INSERT INTO ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
(articleno, branchno, ibttypeid, ibtassortmenttypeid, ibtonlyflag, lastchangedatetime) \
SELECT (100000 + (MOD(rowid, 100) + 11)), (MOD(rowid, 5) * 10 + 10), \
       (MOD(rowid, 3) + 1), (MOD(rowid, 4) + 1), (MOD(rowid, 2)), CURRENT \
FROM ich21@zdev21_tcp:temp_article_reference \
WHERE rowid <= 5;

# Test batch update simulation (commit every 50 records pattern)
[transaction17]
sql=UPDATE ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
SET lastchangedatetime = CURRENT \
WHERE articleno BETWEEN 100011 AND 100015;

# ==============================================================================
# PHASE 7: COMPLEX QUERIES - Test advanced operations
# ==============================================================================

# UC9: Test complex join operations (simulate module's complex selects)
[transaction18]
sql=SELECT (i.articleno || ';' || i.branchno || ';' || a.articlename || ';' || b.branchname || ';' || i.ibttypeid) AS result \
FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig i, \
     ich21@zdev21_tcp:temp_article_reference a, \
     ich21@zdev21_tcp:temp_branch_reference b \
WHERE i.articleno = a.articleno \
  AND i.branchno = b.branchno \
  AND i.ibtonlyflag = 0 \
  AND a.active_flag = 1 \
ORDER BY b.country, i.articleno;
header=articleno;branchno;articlename;branchname;ibttypeid
limit=15

# UC10: Test aggregation operations
[transaction19]
sql=SELECT (b.country || ';' || COUNT(*) || ';' || AVG(i.ibttypeid)) AS result \
FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig i, \
     ich21@zdev21_tcp:temp_branch_reference b \
WHERE i.branchno = b.branchno \
GROUP BY b.country \
ORDER BY COUNT(*) DESC;
header=country;config_count;avg_ibt_type

# ==============================================================================
# PHASE 8: ERROR SIMULATION - Test error handling
# ==============================================================================

# UC11: Test constraint violation handling (duplicate key)
[transaction20]
sql=INSERT INTO ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
(articleno, branchno, ibttypeid, ibtassortmenttypeid, ibtonlyflag, lastchangedatetime) \
VALUES (100001, 10, 1, 1, 0, CURRENT);
# This should fail due to primary key constraint

# UC12: Test null handling
[transaction21]
sql=SELECT (articleno || ';' || branchno || ';' || NVL(ibttypeid, 0) || ';' || NVL(ibtassortmenttypeid, 0)) AS result \
FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
WHERE ibttypeid IS NULL OR ibtassortmenttypeid IS NULL;
header=articleno;branchno;ibttypeid;assortmenttype

# ==============================================================================
# PHASE 9: PERFORMANCE VALIDATION - Test timing and resource usage
# ==============================================================================

# UC13: Performance test - large result set
[transaction22]
sql=SELECT (i.articleno || ';' || i.branchno || ';' || i.ibttypeid || ';' || i.lastchangedatetime) AS result \
FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig i \
ORDER BY i.lastchangedatetime DESC, i.articleno;
header=articleno;branchno;ibttypeid;lastchange
limit=50

# UC14: Performance test - complex aggregation
[transaction23]
sql=SELECT (i.ibttypeid || ';' || i.ibtassortmenttypeid || ';' || COUNT(*) || ';' || \
           COUNT(DISTINCT i.articleno) || ';' || COUNT(DISTINCT i.branchno)) AS result \
FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig i \
GROUP BY i.ibttypeid, i.ibtassortmenttypeid \
ORDER BY COUNT(*) DESC;
header=ibttypeid;assortmenttype;total_configs;unique_articles;unique_branches

# ==============================================================================
# PHASE 10: DATA INTEGRITY VALIDATION - FIXED: Simplified complex nested SELECT
# ==============================================================================

# UC15a: Data consistency check - IBT table count
[transaction24a]
sql=SELECT COUNT(*) AS ibt_count FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig;
header=ibt_count

# UC15b: Data consistency check - PUIBT table count
[transaction24b]
sql=SELECT COUNT(*) AS puibt_count FROM ich21@zdev21_tcp:temp_puibtbrancharticleconfig;
header=puibt_count

# UC15c: Data consistency check - Unique articles
[transaction24c]
sql=SELECT COUNT(DISTINCT articleno) AS unique_articles FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig;
header=unique_articles

# UC15d: Data consistency check - Unique branches
[transaction24d]
sql=SELECT COUNT(DISTINCT branchno) AS unique_branches FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig;
header=unique_branches

# UC16: Timestamp validation - FIXED: Use Informix-compatible date extraction
[transaction25]
sql=SELECT (EXTEND(lastchangedatetime, year to day) || ';' || COUNT(*)) AS result \
FROM ich21@zdev21_tcp:temp_ibtbrancharticleconfig \
WHERE lastchangedatetime >= TODAY \
GROUP BY EXTEND(lastchangedatetime, year to day) \
ORDER BY EXTEND(lastchangedatetime, year to day);
header=change_date;record_count

# ==============================================================================
# PHASE 11: CLEANUP - Drop temporary tables and cleanup resources
# ==============================================================================

# Drop all temporary tables
[transaction26]
sql=DROP TABLE ich21@zdev21_tcp:temp_ibtbrancharticleconfig;

[transaction27]
sql=DROP TABLE ich21@zdev21_tcp:temp_puibtbrancharticleconfig;

[transaction28]
sql=DROP TABLE ich21@zdev21_tcp:temp_article_reference;

[transaction29]
sql=DROP TABLE ich21@zdev21_tcp:temp_branch_reference;

# Final validation - ensure cleanup completed - FIXED: Simple SELECT statement
[transaction30]
sql=SELECT 'CLEANUP_COMPLETE' AS status;
header=status

# ==============================================================================
# END OF CONFIGURATION - TOTAL TRANSACTIONS: 43 (expanded from 31 due to fixes)
# ==============================================================================