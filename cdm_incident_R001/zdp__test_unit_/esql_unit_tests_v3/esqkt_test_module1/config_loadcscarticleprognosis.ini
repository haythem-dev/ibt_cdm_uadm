# ==============================================================================
# LoadCSCArticlePrognosis Module Validation Configuration
# esqltest Framework Configuration File
# 
# Module: pharmos.outbound.csc_load/dev/src/loadcscarticleprognosis
# Purpose: Validate article prognosis data loading from inbound to outbound DB
# Author: AI Assistant
# Date: 2025-01-27
# ==============================================================================

[general]
database=ich21@zdev21_tcp
test_capture_entries_count=10
persistent_connection=1
separator=;
timeout=300
commit_interval=50

# ==============================================================================
# PHASE 1: TABLE STRUCTURE SETUP - Create temporary tables for testing
# ==============================================================================

# Create temporary source table (simulates inbound artprog)
[transaction00]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_artprog_source ( \
    filialnr INTEGER NOT NULL, \
    artikel_nr INTEGER NOT NULL, \
    datum INTEGER NOT NULL, \
    prog_s FLOAT, \
    wprog_s FLOAT, \
    PRIMARY KEY (filialnr, artikel_nr, datum) \
);

# Create temporary target table (simulates cscarticleprognosis)  
[transaction01]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_cscarticleprognosis ( \
    filialnr INTEGER NOT NULL, \
    artikel_nr INTEGER NOT NULL, \
    datum INTEGER NOT NULL, \
    prog_s FLOAT, \
    wprog_s FLOAT, \
    lastupdatedate INTEGER DEFAULT 0, \
    PRIMARY KEY (filialnr, artikel_nr, datum) \
);

# Create processing temp table (simulates tmp_artprog)
[transaction02]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_processing_artprog ( \
    filialnr INTEGER, \
    artikel_nr INTEGER, \
    datum INTEGER, \
    prog_s FLOAT, \
    wprog_s FLOAT \
);

# Create reference data for branch information
[transaction03]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_branch_reference ( \
    filialnr INTEGER NOT NULL PRIMARY KEY, \
    branchname VARCHAR(40), \
    region VARCHAR(20), \
    active_flag INTEGER DEFAULT 1 \
);

# ==============================================================================
# PHASE 2: REFERENCE DATA LOADING - Setup test data
# ==============================================================================

# Load branch reference data - Individual INSERT statements for Informix compatibility
[transaction04]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_reference \
(filialnr, branchname, region, active_flag) VALUES \
(10, 'Central Pharmacy Berlin', 'North', 1);

[transaction05]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_reference \
(filialnr, branchname, region, active_flag) VALUES \
(20, 'Regional Pharmacy Munich', 'South', 1);

[transaction06]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_reference \
(filialnr, branchname, region, active_flag) VALUES \
(30, 'Metro Pharmacy Vienna', 'Central', 1);

[transaction07]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_reference \
(filialnr, branchname, region, active_flag) VALUES \
(40, 'City Pharmacy Zurich', 'West', 1);

[transaction08]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_reference \
(filialnr, branchname, region, active_flag) VALUES \
(50, 'District Pharmacy Prague', 'East', 1);

# Load initial historical data in target table (existing records) - Individual INSERT statements
[transaction09]
sql=INSERT INTO ich21@zdev21_tcp:temp_cscarticleprognosis \
(filialnr, artikel_nr, datum, prog_s, wprog_s, lastupdatedate) VALUES \
(10, 100001, 20241201, 150.5, 35.2, 20241201);

[transaction10]
sql=INSERT INTO ich21@zdev21_tcp:temp_cscarticleprognosis \
(filialnr, artikel_nr, datum, prog_s, wprog_s, lastupdatedate) VALUES \
(10, 100001, 20241202, 148.3, 34.8, 20241201);

[transaction11]
sql=INSERT INTO ich21@zdev21_tcp:temp_cscarticleprognosis \
(filialnr, artikel_nr, datum, prog_s, wprog_s, lastupdatedate) VALUES \
(10, 100002, 20241201, 89.7, 21.1, 20241201);

[transaction12]
sql=INSERT INTO ich21@zdev21_tcp:temp_cscarticleprognosis \
(filialnr, artikel_nr, datum, prog_s, wprog_s, lastupdatedate) VALUES \
(20, 100001, 20241201, 201.4, 47.3, 20241201);

[transaction13]
sql=INSERT INTO ich21@zdev21_tcp:temp_cscarticleprognosis \
(filialnr, artikel_nr, datum, prog_s, wprog_s, lastupdatedate) VALUES \
(20, 100003, 20241202, 76.8, 18.9, 20241201);

# Load source data (simulates inbound artprog with mixed scenarios)
[transaction14]
sql=INSERT INTO ich21@zdev21_tcp:temp_artprog_source \
(filialnr, artikel_nr, datum, prog_s, wprog_s) VALUES \
(10, 100001, 20241203, 152.1, 35.9);

[transaction15]
sql=INSERT INTO ich21@zdev21_tcp:temp_artprog_source \
(filialnr, artikel_nr, datum, prog_s, wprog_s) VALUES \
(10, 100004, 20241203, 95.3, 22.7);

[transaction16]
sql=INSERT INTO ich21@zdev21_tcp:temp_artprog_source \
(filialnr, artikel_nr, datum, prog_s, wprog_s) VALUES \
(30, 100001, 20241203, 178.6, 41.2);

# ==============================================================================
# PHASE 3: BASIC QUERY VALIDATION - Test core operations
# ==============================================================================

# Test data validation - count records
[transaction17]
sql=SELECT (COUNT(*) || ';TOTAL_BRANCH_RECORDS') AS result \
FROM ich21@zdev21_tcp:temp_branch_reference;
header=count;description

# Test data validation - count source records
[transaction18]
sql=SELECT (COUNT(*) || ';TOTAL_SOURCE_RECORDS') AS result \
FROM ich21@zdev21_tcp:temp_artprog_source;
header=count;description

# Test data validation - count target records
[transaction19]
sql=SELECT (COUNT(*) || ';TOTAL_TARGET_RECORDS') AS result \
FROM ich21@zdev21_tcp:temp_cscarticleprognosis;
header=count;description

# ==============================================================================
# PHASE 3: INCREMENTAL LOADING SIMULATION - Test core module logic
# ==============================================================================

# Test incremental data selection (simulates module's core query)
[transaction20]
sql=SELECT (s.filialnr || ';' || s.artikel_nr || ';' || s.datum || ';' || s.prog_s || ';' || s.wprog_s) AS result \
FROM ich21@zdev21_tcp:temp_artprog_source s \
WHERE s.filialnr = 10 \
  AND s.datum >= (SELECT NVL(MAX(lastupdatedate), 0) \
                  FROM ich21@zdev21_tcp:temp_cscarticleprognosis \
                  WHERE filialnr = 10) \
ORDER BY s.datum, s.artikel_nr;
header=filialnr;artikel_nr;datum;prog_s;wprog_s

# Load processing temp table (simulates module's tmp_artprog loading)
[transaction21]  
sql=INSERT INTO ich21@zdev21_tcp:temp_processing_artprog \
SELECT filialnr, artikel_nr, datum, prog_s, wprog_s \
FROM ich21@zdev21_tcp:temp_artprog_source \
WHERE filialnr = 10 \
  AND datum >= (SELECT NVL(MAX(lastupdatedate), 0) \
                FROM ich21@zdev21_tcp:temp_cscarticleprognosis \
                WHERE filialnr = 10);

# Validate processing table load
[transaction22]
sql=SELECT (COUNT(*) || ';PROCESSING_RECORDS_LOADED') AS result \
FROM ich21@zdev21_tcp:temp_processing_artprog;
header=count;description

# ==============================================================================
# PHASE 4: MERGE OPERATION TESTING - Test UPDATE and INSERT logic
# ==============================================================================

# Execute MERGE operation (simulates module's core MERGE logic)
[transaction23]
sql=MERGE INTO ich21@zdev21_tcp:temp_cscarticleprognosis AS cap \
USING ich21@zdev21_tcp:temp_processing_artprog AS tap \
ON cap.filialnr = tap.filialnr \
   AND cap.artikel_nr = tap.artikel_nr \
   AND cap.datum = tap.datum \
WHEN MATCHED THEN \
  UPDATE SET cap.prog_s = tap.prog_s, \
             cap.wprog_s = tap.wprog_s, \
             cap.lastupdatedate = 20241203 \
WHEN NOT MATCHED THEN \
  INSERT (filialnr, artikel_nr, datum, prog_s, wprog_s, lastupdatedate) \
  VALUES (tap.filialnr, tap.artikel_nr, tap.datum, tap.prog_s, tap.wprog_s, 20241203);

# Validate MERGE results - count records by operation type  
[transaction24]
sql=SELECT ('MERGE_SUMMARY;' || \
           (SELECT COUNT(*) FROM ich21@zdev21_tcp:temp_cscarticleprognosis WHERE lastupdatedate = 20241203) || ';' || \
           (SELECT COUNT(*) FROM ich21@zdev21_tcp:temp_cscarticleprognosis) || ';' || \
           (SELECT COUNT(DISTINCT filialnr) FROM ich21@zdev21_tcp:temp_cscarticleprognosis)) AS result;
header=operation;updated_today;total_records;branches_count

# Test record-level validation after MERGE
[transaction25]
sql=SELECT (cap.filialnr || ';' || cap.artikel_nr || ';' || cap.datum || ';' || \
           cap.prog_s || ';' || cap.wprog_s || ';' || cap.lastupdatedate) AS result \
FROM ich21@zdev21_tcp:temp_cscarticleprognosis cap \
WHERE cap.filialnr = 10 AND cap.lastupdatedate = 20241203 \
ORDER BY cap.artikel_nr, cap.datum;
header=filialnr;artikel_nr;datum;prog_s;wprog_s;lastupdatedate

# ==============================================================================
# PHASE 5: DATA CLEANUP SIMULATION - Test deletion of outdated records
# ==============================================================================

# Identify records for cleanup (simulates module's cleanup SELECT)  
[transaction26]
sql=SELECT (cap.filialnr || ';' || cap.artikel_nr || ';' || cap.datum || ';CLEANUP_CANDIDATE') AS result \
FROM ich21@zdev21_tcp:temp_cscarticleprognosis cap \
LEFT OUTER JOIN ich21@zdev21_tcp:temp_artprog_source src \
  ON cap.filialnr = src.filialnr \
     AND cap.artikel_nr = src.artikel_nr \
     AND cap.datum = src.datum \
WHERE cap.filialnr = 10 \
  AND src.datum IS NULL \
ORDER BY cap.artikel_nr, cap.datum;
header=filialnr;artikel_nr;datum;cleanup_status

# Execute cleanup deletion (simulates module's DELETE logic)
[transaction27]
sql=DELETE FROM ich21@zdev21_tcp:temp_cscarticleprognosis \
WHERE filialnr = 10 \
  AND NOT EXISTS (SELECT 1 FROM ich21@zdev21_tcp:temp_artprog_source src \
                  WHERE src.filialnr = temp_cscarticleprognosis.filialnr \
                    AND src.artikel_nr = temp_cscarticleprognosis.artikel_nr \
                    AND src.datum = temp_cscarticleprognosis.datum);

# Validate cleanup results
[transaction28]
sql=SELECT (COUNT(*) || ';RECORDS_AFTER_CLEANUP') AS result \
FROM ich21@zdev21_tcp:temp_cscarticleprognosis \
WHERE filialnr = 10;
header=count;description

# Additional cleanup validation summary
[transaction29]
sql=SELECT ('CLEANUP_SUMMARY;' || \
           (SELECT COUNT(*) FROM ich21@zdev21_tcp:temp_cscarticleprognosis WHERE filialnr = 10) || ';' || \
           (SELECT COUNT(*) FROM ich21@zdev21_tcp:temp_cscarticleprognosis)) AS result;
header=operation;branch_10_records;total_records

# ==============================================================================
# PHASE 6: BATCH PROCESSING SIMULATION - Test large dataset handling
# ==============================================================================

# Create larger dataset for batch processing test - using fixed values instead of RANDOM
[transaction30]
sql=INSERT INTO ich21@zdev21_tcp:temp_artprog_source \
SELECT 20, (100000 + (MOD(rowid, 50) + 1)), (20241204 + MOD(rowid, 7)), \
       (150.0 + MOD(rowid, 100)), (30.0 + MOD(rowid, 20)) \
FROM ich21@zdev21_tcp:temp_branch_reference \
WHERE rowid <= 5;

# Simulate batch processing with branch 20
[transaction31]  
sql=INSERT INTO ich21@zdev21_tcp:temp_processing_artprog \
SELECT filialnr, artikel_nr, datum, prog_s, wprog_s \
FROM ich21@zdev21_tcp:temp_artprog_source \
WHERE filialnr = 20 \
  AND datum >= (SELECT NVL(MAX(lastupdatedate), 0) \
                FROM ich21@zdev21_tcp:temp_cscarticleprognosis \
                WHERE filialnr = 20);

# Execute batch MERGE
[transaction32]
sql=MERGE INTO ich21@zdev21_tcp:temp_cscarticleprognosis AS cap \
USING ich21@zdev21_tcp:temp_processing_artprog AS tap \
ON cap.filialnr = tap.filialnr \
   AND cap.artikel_nr = tap.artikel_nr \
   AND cap.datum = tap.datum \
WHEN MATCHED THEN \
  UPDATE SET cap.prog_s = tap.prog_s, \
             cap.wprog_s = tap.wprog_s, \
             cap.lastupdatedate = 20241204 \
WHEN NOT MATCHED THEN \
  INSERT (filialnr, artikel_nr, datum, prog_s, wprog_s, lastupdatedate) \
  VALUES (tap.filialnr, tap.artikel_nr, tap.datum, tap.prog_s, tap.wprog_s, 20241204);

# ==============================================================================
# PHASE 7: BUSINESS LOGIC VALIDATION - Test module-specific scenarios
# ==============================================================================

# Test multi-branch processing results
[transaction33]
sql=SELECT (br.branchname || ';' || COUNT(cap.artikel_nr) || ';' || AVG(cap.prog_s) || ';' || MAX(cap.lastupdatedate)) AS result \
FROM ich21@zdev21_tcp:temp_cscarticleprognosis cap, \
     ich21@zdev21_tcp:temp_branch_reference br \
WHERE cap.filialnr = br.filialnr \
GROUP BY br.filialnr, br.branchname \
ORDER BY COUNT(cap.artikel_nr) DESC;
header=branchname;article_count;avg_prognosis;last_update

# Validate date-based incremental logic
[transaction34]
sql=SELECT (DATE(lastupdatedate) || ';' || COUNT(*) || ';' || AVG(prog_s)) AS result \
FROM ich21@zdev21_tcp:temp_cscarticleprognosis \
WHERE lastupdatedate >= 20241201 \
GROUP BY DATE(lastupdatedate) \
ORDER BY DATE(lastupdatedate);
header=update_date;record_count;avg_prognosis

# Test prognosis value ranges and data quality
[transaction35]
sql=SELECT ('DATA_QUALITY;' || \
           (SELECT COUNT(*) FROM ich21@zdev21_tcp:temp_cscarticleprognosis WHERE prog_s IS NULL) || ';' || \
           (SELECT COUNT(*) FROM ich21@zdev21_tcp:temp_cscarticleprognosis WHERE wprog_s IS NULL) || ';' || \
           (SELECT COUNT(*) FROM ich21@zdev21_tcp:temp_cscarticleprognosis WHERE prog_s < 0) || ';' || \
           (SELECT COUNT(*) FROM ich21@zdev21_tcp:temp_cscarticleprognosis WHERE wprog_s < 0)) AS result;
header=check_type;null_prog_s;null_wprog_s;negative_prog_s;negative_wprog_s

# ==============================================================================
# PHASE 8: ERROR HANDLING SIMULATION - Test edge cases
# ==============================================================================

# Test with NULL values handling
[transaction36]
sql=INSERT INTO ich21@zdev21_tcp:temp_artprog_source \
(filialnr, artikel_nr, datum, prog_s, wprog_s) VALUES \
(30, 100008, 20241205, NULL, 25.5);

[transaction37]
sql=INSERT INTO ich21@zdev21_tcp:temp_artprog_source \
(filialnr, artikel_nr, datum, prog_s, wprog_s) VALUES \
(30, 100009, 20241205, 125.3, NULL);

# Test duplicate key handling (should update existing)
[transaction38]
sql=INSERT INTO ich21@zdev21_tcp:temp_processing_artprog \
SELECT filialnr, artikel_nr, datum, prog_s, wprog_s \
FROM ich21@zdev21_tcp:temp_artprog_source \
WHERE filialnr = 30 AND datum = 20241205;

# Execute final MERGE with edge cases
[transaction39]
sql=MERGE INTO ich21@zdev21_tcp:temp_cscarticleprognosis AS cap \
USING ich21@zdev21_tcp:temp_processing_artprog AS tap \
ON cap.filialnr = tap.filialnr \
   AND cap.artikel_nr = tap.artikel_nr \
   AND cap.datum = tap.datum \
WHEN MATCHED THEN \
  UPDATE SET cap.prog_s = NVL(tap.prog_s, cap.prog_s), \
             cap.wprog_s = NVL(tap.wprog_s, cap.wprog_s), \
             cap.lastupdatedate = 20241205 \
WHEN NOT MATCHED THEN \
  INSERT (filialnr, artikel_nr, datum, prog_s, wprog_s, lastupdatedate) \
  VALUES (tap.filialnr, tap.artikel_nr, tap.datum, \
          NVL(tap.prog_s, 0), NVL(tap.wprog_s, 0), 20241205);

# ==============================================================================
# PHASE 9: PERFORMANCE VALIDATION - Test timing and efficiency
# ==============================================================================

# Performance test - large result set with aggregations
[transaction40]
sql=SELECT (cap.filialnr || ';' || COUNT(*) || ';' || \
           SUM(cap.prog_s) || ';' || SUM(cap.wprog_s) || ';' || \
           MIN(cap.datum) || ';' || MAX(cap.datum)) AS result \
FROM ich21@zdev21_tcp:temp_cscarticleprognosis cap \
GROUP BY cap.filialnr \
ORDER BY COUNT(*) DESC;
header=filialnr;record_count;total_prog_s;total_wprog_s;min_date;max_date
limit=20

# Test complex joins (simulates module's complex operations)
[transaction41]
sql=SELECT (cap.filialnr || ';' || br.branchname || ';' || cap.artikel_nr || ';' || \
           cap.prog_s || ';' || cap.wprog_s || ';' || cap.lastupdatedate) AS result \
FROM ich21@zdev21_tcp:temp_cscarticleprognosis cap, \
     ich21@zdev21_tcp:temp_branch_reference br \
WHERE cap.filialnr = br.filialnr \
  AND br.active_flag = 1 \
  AND cap.prog_s > 100 \
ORDER BY cap.prog_s DESC, cap.artikel_nr;
header=filialnr;branchname;artikel_nr;prog_s;wprog_s;lastupdatedate
limit=15

# ==============================================================================
# PHASE 10: FINAL VALIDATION - Comprehensive data integrity check
# ==============================================================================

# Final comprehensive validation
[transaction42]
sql=SELECT ('FINAL_VALIDATION;' || \
           (SELECT COUNT(*) FROM ich21@zdev21_tcp:temp_cscarticleprognosis) || ';' || \
           (SELECT COUNT(DISTINCT filialnr) FROM ich21@zdev21_tcp:temp_cscarticleprognosis) || ';' || \
           (SELECT COUNT(DISTINCT artikel_nr) FROM ich21@zdev21_tcp:temp_cscarticleprognosis) || ';' || \
           (SELECT COUNT(*) FROM ich21@zdev21_tcp:temp_cscarticleprognosis WHERE lastupdatedate >= 20241203)) AS result;
header=validation_type;total_records;unique_branches;unique_articles;recent_updates

# Data consistency cross-check
[transaction43]
sql=SELECT (cap.filialnr || ';' || \
           COUNT(*) || ';' || \
           COUNT(CASE WHEN cap.prog_s > 0 THEN 1 END) || ';' || \
           COUNT(CASE WHEN cap.wprog_s > 0 THEN 1 END)) AS result \
FROM ich21@zdev21_tcp:temp_cscarticleprognosis cap \
GROUP BY cap.filialnr \
HAVING COUNT(*) > 0 \
ORDER BY cap.filialnr;
header=filialnr;total_records;positive_prog_s;positive_wprog_s

# ==============================================================================
# PHASE 11: CLEANUP - Drop temporary tables
# ==============================================================================

# Drop all temporary tables
[transaction44]
sql=DROP TABLE ich21@zdev21_tcp:temp_artprog_source;

[transaction45]
sql=DROP TABLE ich21@zdev21_tcp:temp_cscarticleprognosis;

[transaction46]
sql=DROP TABLE ich21@zdev21_tcp:temp_processing_artprog;

[transaction47]
sql=DROP TABLE ich21@zdev21_tcp:temp_branch_reference;

# Final validation - ensure cleanup completed
[transaction48]
sql=SELECT 'VALIDATION_COMPLETE' AS result;
header=status

# ==============================================================================
# END OF CONFIGURATION  
# ==============================================================================