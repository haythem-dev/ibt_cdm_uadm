This page must be filled out for each Change. Without Analysis no implementation will be started.

Business Context (mandatory):

Current Business Problem

The TPLDAUFTR process is a critical component of the PHARMOS CSC_LOAD package responsible for archiving closed customer orders from the active KDAUFTRAG table to the historical AKDAUFTRAG table. The current implementation has a fundamental timing flaw that creates significant business disruption during emergency operations: The original tpldauftrag application archived closed orders from the kdauftrag table to the akdauftrag table WITHOUT ANY BUSINESS DAY LOGIC. This created critical operational issues:

Problem Description:

Normal Operation: Process runs at 23:30 nightly, correctly archiving same business day orders:  before the next business day

Emergency Scenario: When process runs during business hours (e.g., 08:00, 14:00), it archives current day orders

Business Impact: Orders become invisible to customer service representatives, creating operational blindness

Countries Affected:

AT (Austria), BG (Bulgaria), CH (Switzerland), DE (Germany), FR (France), HR (Croatia)

Business Requirements

Primary Goal: Ensure only previous business day closed orders are archived ✅

Challenge: Handle different start times intelligently:

If started late at night (e.g., 23:30) → Archive same business day orders  

If started next morning (e.g., 8:00 AM) → Archive only previous business day orders

Business Value

Maintains visibility of current business day orders for operational teams

Prevents accidental archiving of orders that are still relevant for daily operations

Ensures data integrity and business continuity

Process (mandatory):

Current Process Flow

Normal Night Execution (23:30):

1. TPLDAUFTR starts at 23:30
2. Queries KDAUFTRAG for CLOSED orders where DATUMVALUTA <= CURRENT_DATE
3. Archives orders to AKDAUFTRAG tables
4. Deletes archived orders from active tables
5. Business day orders properly archived ✓ CORRECT ✅

Emergency Day Execution (08:00-18:00):

1. TPLDAUFTR starts during business hours
2. Queries KDAUFTRAG for CLOSED orders where DATUMVALUTA <= CURRENT_DATE
3. Archives TODAY's orders to AKDAUFTRAG tables
4. Deletes TODAY's orders from active tables
5. Current business day orders become invisible ✗ PROBLEM

Proposed Enhanced Process Flow

✅Enhanced tpldauftrag application starts with new time-aware logic

✅Business Day Determination:

Calculate current business day based on system time

Determine appropriate archive cutoff date based on start time

✅Smart Date Logic:

If current time is between 00:00 and business cutoff (e.g., 06:00): Archive previous business day only

If current time is after business cutoff: Archive current business day

✅Selective Order Archiving:

Filter closed orders by determined cutoff date

Move only qualifying orders to akdauftrag archive

✅Process completion with enhanced logging

Data Model/DB Tables (optional if DB is involved and/or to be changed):

Primary Tables Affected

kdauftrag (Customer Orders - Active)

Purpose: Main table containing active customer orders  
Key Fields for Enhancement:

Order Date/Time fields for business day calculation

Order Status fields to identify closed orders

Timestamp fields for archiving logic

akdauftrag (Customer Orders - Archive)

Purpose: Archive table for processed/closed orders  
Relationship: Target table for archived orders from kdauftrag

Data Considerations

Date Fields: Ensure proper date/time handling for business day logic

Index Requirements: May need indexing on date fields for performance

Data Integrity: Maintain referential integrity during archive process

Audit Trail: Consider adding archive timestamp and reason fields

Potential Schema Enhancements

Add archive reason/source tracking

Consider business day metadata table for complex business rules

Ensure proper timezone handling for global operations

SQL Query Enhancement 

Original SQL (archived ALL closed orders - PROBLEM):

INSERT INTO akdauftrag SELECT * FROM kdauftrag 
WHERE datumauslieferung <= %ld 
AND kzgeschlossen = '1' 
AND filnr = %d

✅ IMPLEMENTED Enhanced SQL (with business day filtering):

INSERT INTO akdauftrag SELECT * FROM kdauftrag 
WHERE datumauslieferung <= %ld 
AND kzgeschlossen = '1' 
AND filnr = %d 
AND datumvaluta <= %ld  -- ✅ NEW: Business day filter IMPLEMENTED

✅ ROLLBACK SQL (when --disable-business-day used):

-- Exact original behavior restored
INSERT INTO akdauftrag SELECT * FROM kdauftrag 
WHERE datumauslieferung <= %ld 
AND kzgeschlossen = '1' 
AND filnr = %d

Frontend - Windows/Citrix (optional if a Frontend is involved and/or to be changed):

Impact Assessment

No Frontend Changes Required

The TPLDAUFTR enhancement is a backend batch process modification. However, the business impact affects frontend systems:

Positive Frontend Impact:

Customer Service Applications: Orders remain visible during emergency operations

Order Management Systems: Consistent order availability during business hours

Reporting Systems: Improved data consistency and availability

User Experience Improvements:

Customer Service Reps: No more "missing order" scenarios during emergencies

Business Users: Consistent order lookup capabilities

Operations Staff: Enhanced control over archiving process

Backend - AIX / Windows Webserver (optional if a Backend is involved and/or to be changed):

Core Technical Implementation 

1. C++ Application Changes (tpldauftrag.cxx) 

// ✅ IMPLEMENTED: Business day calculation function
int calculate_business_day_archive_date() {
    time_t now;
    struct tm* timeinfo;
    
    time(&now);
    timeinfo = localtime(&now);
    
    if (timeinfo->tm_hour < BUSINESS_DAY_CUTOFF_HOUR) {
        // ✅ Before 6 AM - use previous business day (emergency scenario)
        // ✅ Handle weekend rollback logic
        return calculate_previous_business_day();
    } else {
        // ✅ After 6 AM - use current business day (normal scenario)
        return calculate_current_business_day();
    }
}

2. Enhanced Command Line Parameters

✅ --enable-business-day: Enable business day logic (DEFAULT BEHAVIOR)

✅ --disable-business-day: Complete rollback to original behavior

✅ --help: Complete usage instructions

✅ --version: Version and feature status information

3. SQL Query Modification 

// ✅ IMPLEMENTED: Conditional date filtering
if (g_business_day_enabled && lBusinessDayDate > 0) {
    sprintf(szStatement,
            "INSERT INTO akdauftrag SELECT * FROM kdauftrag WHERE datumauslieferung <= %ld AND kzgeschlossen = '1' AND filnr = %d AND datumvaluta <= %ld",
            lDatumAktuell, iAnzahlVon, lBusinessDayDate);
} else {
    // ✅ EXACT ORIGINAL BEHAVIOR when disabled
    sprintf(szStatement,
            "INSERT INTO akdauftrag SELECT * FROM kdauftrag WHERE datumauslieferung <= %ld AND kzgeschlossen = '1' AND filnr = %d",
            lDatumAktuell, iAnzahlVon);
}

4. Enhanced Logging

✅ Logs calculated business day date

✅ Logs business day mode status (enabled/disabled)

✅ Logs SQL query type being executed

✅ Logs emergency vs normal run detection

✅ Complete audit trail for troubleshooting

Implementation Specification

Core Implementation Tasks  

✅ Modified tpldauftr.cxx: Business day calculation functions implemented

✅ Enhanced SQL queries: Conditional date filtering logic implemented

✅ Added command-line parameters: Complete business day mode controls

✅ Implemented logging: Comprehensive operational monitoring

✅ Validated backward compatibility: Perfect rollback capability with --disable-business-day

Dependent department inputs (optional if any external department outside PHARMOS is involved):

PINT

Citrix

Infrastructure Env

Schedule/Batch

BI

GxP (in case of GxP relevance)

Documents (Analysis and Solution Specification):