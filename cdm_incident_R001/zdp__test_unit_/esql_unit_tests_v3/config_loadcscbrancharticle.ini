# ==============================================================================
# LoadCSCBranchArticle Module Validation Configuration
# esqltest Framework Configuration File
# 
# Module: pharmos.outbound.csc_load/dev/src/loadcscbrancharticle
# Purpose: Validate branch article data loading from inbound to outbound DB
# Author: AI Assistant  
# Date: 2025-01-29
# Version: 1.0 (Comprehensive Validation Suite)
# ==============================================================================

[general]
database=ich21@zdev21_tcp
test_capture_entries_count=10
persistent_connection=1
separator=;
timeout=300
commit_interval=50

# ==============================================================================
# PHASE 1: TABLE STRUCTURE SETUP - Create temporary tables for testing
# ==============================================================================

# Create temporary source table (simulates inbound artikelf)
[transaction00]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_artikelf_source ( \
    filialnr INTEGER NOT NULL, \
    artikel_nr INTEGER NOT NULL, \
    besla_nr INTEGER, \
    bestand_min INTEGER, \
    artikelaktiv CHAR(1), \
    lagerfachnr CHAR(10), \
    offene_bestmenge INTEGER, \
    datum_aender INTEGER NOT NULL, \
    openorderqty_noteffective INTEGER, \
    PRIMARY KEY (filialnr, artikel_nr) \
);

# Create temporary target table (simulates cscbrancharticle)
[transaction01]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_cscbrancharticle ( \
    filialnr INTEGER NOT NULL, \
    artikel_nr INTEGER NOT NULL, \
    besla_nr INTEGER, \
    bestand_min INTEGER, \
    artikelaktiv CHAR(1), \
    lagerfachnr CHAR(10), \
    offene_bestmenge INTEGER, \
    openorderqty_noteffective INTEGER, \
    lastupdatedate INTEGER DEFAULT 0, \
    PRIMARY KEY (filialnr, artikel_nr) \
);

# Create processing temp table (simulates tmp_artikelf)
[transaction02]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_processing_artikelf ( \
    filialnr INTEGER, \
    artikel_nr INTEGER, \
    besla_nr INTEGER, \
    bestand_min INTEGER, \
    artikelaktiv CHAR(1), \
    lagerfachnr CHAR(10), \
    offene_bestmenge INTEGER, \
    datum_aender INTEGER, \
    openorderqty_noteffective INTEGER \
);

# Create branch reference data
[transaction03]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_branch_reference ( \
    filialnr INTEGER NOT NULL PRIMARY KEY, \
    branchname VARCHAR(40), \
    region VARCHAR(20), \
    active_flag INTEGER DEFAULT 1 \
);

# Create validation results table
[transaction04]
sql=CREATE TEMP TABLE ich21@zdev21_tcp:temp_validation_results ( \
    validation_type VARCHAR(50), \
    metric_name VARCHAR(50), \
    metric_value INTEGER, \
    description VARCHAR(100) \
);

# ==============================================================================
# PHASE 2: REFERENCE DATA LOADING - Setup test data
# ==============================================================================

# Load branch reference data
[transaction05]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_reference \
(filialnr, branchname, region, active_flag) VALUES \
(10, 'Central Branch Berlin', 'North', 1);

[transaction06]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_reference \
(filialnr, branchname, region, active_flag) VALUES \
(20, 'Regional Branch Munich', 'South', 1);

[transaction07]
sql=INSERT INTO ich21@zdev21_tcp:temp_branch_reference \
(filialnr, branchname, region, active_flag) VALUES \
(30, 'Metro Branch Vienna', 'Central', 1);

# Load initial historical data in target table (existing records)
[transaction08]
sql=INSERT INTO ich21@zdev21_tcp:temp_cscbrancharticle \
(filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, openorderqty_noteffective, lastupdatedate) VALUES \
(10, 100001, 501, 25, 'Y', 'A001', 150, 75, 20250125);

[transaction09]
sql=INSERT INTO ich21@zdev21_tcp:temp_cscbrancharticle \
(filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, openorderqty_noteffective, lastupdatedate) VALUES \
(10, 100002, 502, 30, 'Y', 'A002', 200, 100, 20250125);

[transaction10]
sql=INSERT INTO ich21@zdev21_tcp:temp_cscbrancharticle \
(filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, openorderqty_noteffective, lastupdatedate) VALUES \
(20, 100001, 503, 20, 'Y', 'B001', 180, 90, 20250125);

# Load source data (simulates inbound artikelf with mixed scenarios)
[transaction11]
sql=INSERT INTO ich21@zdev21_tcp:temp_artikelf_source \
(filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective) VALUES \
(10, 100001, 501, 30, 'Y', 'A001', 175, 20250126, 80);

[transaction12]
sql=INSERT INTO ich21@zdev21_tcp:temp_artikelf_source \
(filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective) VALUES \
(10, 100003, 504, 15, 'Y', 'A003', 120, 20250126, 60);

[transaction13]
sql=INSERT INTO ich21@zdev21_tcp:temp_artikelf_source \
(filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective) VALUES \
(30, 100001, 505, 25, 'Y', 'C001', 160, 20250126, 85);

# ==============================================================================
# PHASE 3: BASIC QUERY VALIDATION - Test core operations
# ==============================================================================

# Test data validation - count records
[transaction14]
sql=SELECT (COUNT(*) || ';TOTAL_BRANCH_RECORDS') AS result \
FROM ich21@zdev21_tcp:temp_branch_reference;
header=count;description

[transaction15]
sql=SELECT (COUNT(*) || ';TOTAL_SOURCE_RECORDS') AS result \
FROM ich21@zdev21_tcp:temp_artikelf_source;
header=count;description

[transaction16]
sql=SELECT (COUNT(*) || ';TOTAL_TARGET_RECORDS') AS result \
FROM ich21@zdev21_tcp:temp_cscbrancharticle;
header=count;description

# ==============================================================================
# PHASE 4: INCREMENTAL LOADING SIMULATION - Test core module logic
# ==============================================================================

# Test incremental data selection (simulates module's core query)
[transaction17]
sql=SELECT (s.filialnr || ';' || s.artikel_nr || ';' || s.besla_nr || ';' || s.bestand_min || ';' || s.artikelaktiv || ';' || s.lagerfachnr || ';' || s.offene_bestmenge || ';' || s.datum_aender || ';' || s.openorderqty_noteffective) AS result \
FROM ich21@zdev21_tcp:temp_artikelf_source s \
WHERE s.filialnr = 10 \
  AND s.datum_aender >= (SELECT NVL(MAX(lastupdatedate), 0) \
                         FROM ich21@zdev21_tcp:temp_cscbrancharticle \
                         WHERE filialnr = 10) \
ORDER BY s.artikel_nr;
header=filialnr;artikel_nr;besla_nr;bestand_min;artikelaktiv;lagerfachnr;offene_bestmenge;datum_aender;openorderqty_noteffective

# Load processing temp table (simulates module's tmp_artikelf loading)
[transaction18]
sql=INSERT INTO ich21@zdev21_tcp:temp_processing_artikelf \
SELECT filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective \
FROM ich21@zdev21_tcp:temp_artikelf_source \
WHERE filialnr = 10 \
  AND datum_aender >= (SELECT NVL(MAX(lastupdatedate), 0) \
                       FROM ich21@zdev21_tcp:temp_cscbrancharticle \
                       WHERE filialnr = 10);

# Validate processing table load
[transaction19]
sql=SELECT (COUNT(*) || ';PROCESSING_RECORDS_LOADED') AS result \
FROM ich21@zdev21_tcp:temp_processing_artikelf;
header=count;description

# ==============================================================================
# PHASE 5: MERGE OPERATION TESTING - Test UPDATE and INSERT logic
# ==============================================================================

# Execute MERGE operation (simulates module's core MERGE logic)
[transaction20]
sql=MERGE INTO ich21@zdev21_tcp:temp_cscbrancharticle AS cba \
USING ich21@zdev21_tcp:temp_processing_artikelf AS taf \
ON cba.filialnr = taf.filialnr AND cba.artikel_nr = taf.artikel_nr \
WHEN MATCHED THEN \
  UPDATE SET cba.besla_nr = taf.besla_nr, \
             cba.bestand_min = taf.bestand_min, \
             cba.artikelaktiv = taf.artikelaktiv, \
             cba.lagerfachnr = taf.lagerfachnr, \
             cba.offene_bestmenge = taf.offene_bestmenge, \
             cba.openorderqty_noteffective = taf.openorderqty_noteffective, \
             cba.lastupdatedate = 20250126 \
WHEN NOT MATCHED THEN \
  INSERT (filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, openorderqty_noteffective, lastupdatedate) \
  VALUES (taf.filialnr, taf.artikel_nr, taf.besla_nr, taf.bestand_min, taf.artikelaktiv, taf.lagerfachnr, taf.offene_bestmenge, taf.openorderqty_noteffective, 20250126);

# Count records updated today
[transaction21]
sql=INSERT INTO ich21@zdev21_tcp:temp_validation_results \
SELECT 'MERGE_SUMMARY', 'updated_today', COUNT(*), 'Records updated today' \
FROM ich21@zdev21_tcp:temp_cscbrancharticle \
WHERE lastupdatedate = 20250126;

# Count total records
[transaction22]
sql=INSERT INTO ich21@zdev21_tcp:temp_validation_results \
SELECT 'MERGE_SUMMARY', 'total_records', COUNT(*), 'Total records in table' \
FROM ich21@zdev21_tcp:temp_cscbrancharticle;

# Display MERGE summary results
[transaction23]
sql=SELECT (validation_type || ';' || metric_name || ';' || metric_value || ';' || description) AS result \
FROM ich21@zdev21_tcp:temp_validation_results \
WHERE validation_type = 'MERGE_SUMMARY' \
ORDER BY metric_name;
header=operation;metric;value;description

# Test record-level validation after MERGE
[transaction24]
sql=SELECT (cba.filialnr || ';' || cba.artikel_nr || ';' || cba.besla_nr || ';' || cba.bestand_min || ';' || cba.artikelaktiv || ';' || cba.lagerfachnr || ';' || cba.offene_bestmenge || ';' || cba.openorderqty_noteffective || ';' || cba.lastupdatedate) AS result \
FROM ich21@zdev21_tcp:temp_cscbrancharticle cba \
WHERE cba.filialnr = 10 AND cba.lastupdatedate = 20250126 \
ORDER BY cba.artikel_nr;
header=filialnr;artikel_nr;besla_nr;bestand_min;artikelaktiv;lagerfachnr;offene_bestmenge;openorderqty_noteffective;lastupdatedate

# ==============================================================================
# PHASE 6: DATA CLEANUP SIMULATION - Test deletion of outdated records
# ==============================================================================

# Identify records for cleanup (simulates module's cleanup SELECT)
[transaction25]
sql=SELECT (cba.filialnr || ';' || cba.artikel_nr || ';' || cba.besla_nr || ';CLEANUP_CANDIDATE') AS result \
FROM ich21@zdev21_tcp:temp_cscbrancharticle cba \
LEFT OUTER JOIN ich21@zdev21_tcp:temp_artikelf_source src \
  ON cba.filialnr = src.filialnr AND cba.artikel_nr = src.artikel_nr \
WHERE cba.filialnr = 10 \
  AND src.artikel_nr IS NULL \
ORDER BY cba.artikel_nr;
header=filialnr;artikel_nr;besla_nr;cleanup_status

# Execute cleanup deletion (simulates module's DELETE logic)
[transaction26]
sql=DELETE FROM ich21@zdev21_tcp:temp_cscbrancharticle \
WHERE filialnr = 10 \
  AND artikel_nr IN ( \
    SELECT cba.artikel_nr FROM ich21@zdev21_tcp:temp_cscbrancharticle cba \
    LEFT OUTER JOIN ich21@zdev21_tcp:temp_artikelf_source src \
      ON cba.filialnr = src.filialnr AND cba.artikel_nr = src.artikel_nr \
    WHERE cba.filialnr = 10 AND src.artikel_nr IS NULL);

# Validate cleanup results
[transaction27]
sql=SELECT (COUNT(*) || ';RECORDS_AFTER_CLEANUP') AS result \
FROM ich21@zdev21_tcp:temp_cscbrancharticle \
WHERE filialnr = 10;
header=count;description

# ==============================================================================
# PHASE 7: BATCH PROCESSING SIMULATION - Test large dataset handling
# ==============================================================================

# Create larger dataset for batch processing test
[transaction28]
sql=INSERT INTO ich21@zdev21_tcp:temp_artikelf_source \
SELECT 20, (100010 + MOD(rowid, 10)), (500 + MOD(rowid, 5)), (10 + MOD(rowid, 20)), 'Y', \
       ('B00' || (MOD(rowid, 9) + 1)), (100 + MOD(rowid, 50)), 20250127, (50 + MOD(rowid, 30)) \
FROM ich21@zdev21_tcp:temp_branch_reference \
WHERE rowid <= 3;

# Clear processing temp table for batch operation
[transaction29]
sql=DELETE FROM ich21@zdev21_tcp:temp_processing_artikelf;

# Simulate batch processing with branch 20
[transaction30]
sql=INSERT INTO ich21@zdev21_tcp:temp_processing_artikelf \
SELECT filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective \
FROM ich21@zdev21_tcp:temp_artikelf_source \
WHERE filialnr = 20 \
  AND datum_aender >= (SELECT NVL(MAX(lastupdatedate), 0) \
                       FROM ich21@zdev21_tcp:temp_cscbrancharticle \
                       WHERE filialnr = 20);

# Execute batch MERGE
[transaction31]
sql=MERGE INTO ich21@zdev21_tcp:temp_cscbrancharticle AS cba \
USING ich21@zdev21_tcp:temp_processing_artikelf AS taf \
ON cba.filialnr = taf.filialnr AND cba.artikel_nr = taf.artikel_nr \
WHEN MATCHED THEN \
  UPDATE SET cba.besla_nr = taf.besla_nr, \
             cba.bestand_min = taf.bestand_min, \
             cba.artikelaktiv = taf.artikelaktiv, \
             cba.lagerfachnr = taf.lagerfachnr, \
             cba.offene_bestmenge = taf.offene_bestmenge, \
             cba.openorderqty_noteffective = taf.openorderqty_noteffective, \
             cba.lastupdatedate = 20250127 \
WHEN NOT MATCHED THEN \
  INSERT (filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, openorderqty_noteffective, lastupdatedate) \
  VALUES (taf.filialnr, taf.artikel_nr, taf.besla_nr, taf.bestand_min, taf.artikelaktiv, taf.lagerfachnr, taf.offene_bestmenge, taf.openorderqty_noteffective, 20250127);

# ==============================================================================
# PHASE 8: BUSINESS LOGIC VALIDATION - Test module-specific scenarios
# ==============================================================================

# Test multi-branch processing results
[transaction32]
sql=SELECT (br.branchname || ';' || COUNT(cba.artikel_nr) || ';' || AVG(cba.bestand_min) || ';' || MAX(cba.lastupdatedate)) AS result \
FROM ich21@zdev21_tcp:temp_cscbrancharticle cba, \
     ich21@zdev21_tcp:temp_branch_reference br \
WHERE cba.filialnr = br.filialnr \
GROUP BY br.filialnr, br.branchname \
ORDER BY COUNT(cba.artikel_nr) DESC;
header=branchname;article_count;avg_min_stock;last_update

# Test article activity status distribution
[transaction33]
sql=SELECT (artikelaktiv || ';' || COUNT(*) || ';ACTIVITY_STATUS') AS result \
FROM ich21@zdev21_tcp:temp_cscbrancharticle \
GROUP BY artikelaktiv \
ORDER BY artikelaktiv;
header=status;count;description

# Data quality checks
[transaction34]
sql=INSERT INTO ich21@zdev21_tcp:temp_validation_results \
SELECT 'DATA_QUALITY', 'null_besla_nr', COUNT(*), 'Records with NULL besla_nr' \
FROM ich21@zdev21_tcp:temp_cscbrancharticle \
WHERE besla_nr IS NULL;

[transaction35]
sql=INSERT INTO ich21@zdev21_tcp:temp_validation_results \
SELECT 'DATA_QUALITY', 'negative_bestand_min', COUNT(*), 'Records with negative bestand_min' \
FROM ich21@zdev21_tcp:temp_cscbrancharticle \
WHERE bestand_min < 0;

[transaction36]
sql=INSERT INTO ich21@zdev21_tcp:temp_validation_results \
SELECT 'DATA_QUALITY', 'inactive_articles', COUNT(*), 'Records with inactive articles' \
FROM ich21@zdev21_tcp:temp_cscbrancharticle \
WHERE artikelaktiv = 'N';

# Display data quality summary
[transaction37]
sql=SELECT (validation_type || ';' || metric_name || ';' || metric_value || ';' || description) AS result \
FROM ich21@zdev21_tcp:temp_validation_results \
WHERE validation_type = 'DATA_QUALITY' \
ORDER BY metric_name;
header=check_type;metric;value;description

# ==============================================================================
# PHASE 9: ERROR HANDLING SIMULATION - Test edge cases
# ==============================================================================

# Clear processing temp table for edge case testing
[transaction38]
sql=DELETE FROM ich21@zdev21_tcp:temp_processing_artikelf;

# Test with NULL values handling
[transaction39]
sql=INSERT INTO ich21@zdev21_tcp:temp_artikelf_source \
(filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective) VALUES \
(30, 100008, NULL, 20, 'Y', 'C008', 140, 20250128, 70);

[transaction40]
sql=INSERT INTO ich21@zdev21_tcp:temp_artikelf_source \
(filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective) VALUES \
(30, 100009, 506, NULL, 'Y', NULL, 160, 20250128, NULL);

# Test edge case processing
[transaction41]
sql=INSERT INTO ich21@zdev21_tcp:temp_processing_artikelf \
SELECT filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, datum_aender, openorderqty_noteffective \
FROM ich21@zdev21_tcp:temp_artikelf_source \
WHERE filialnr = 30 AND datum_aender = 20250128;

# Execute final MERGE with edge cases
[transaction42]
sql=MERGE INTO ich21@zdev21_tcp:temp_cscbrancharticle AS cba \
USING ich21@zdev21_tcp:temp_processing_artikelf AS taf \
ON cba.filialnr = taf.filialnr AND cba.artikel_nr = taf.artikel_nr \
WHEN MATCHED THEN \
  UPDATE SET cba.besla_nr = NVL(taf.besla_nr, cba.besla_nr), \
             cba.bestand_min = NVL(taf.bestand_min, cba.bestand_min), \
             cba.artikelaktiv = NVL(taf.artikelaktiv, cba.artikelaktiv), \
             cba.lagerfachnr = NVL(taf.lagerfachnr, cba.lagerfachnr), \
             cba.offene_bestmenge = NVL(taf.offene_bestmenge, cba.offene_bestmenge), \
             cba.openorderqty_noteffective = NVL(taf.openorderqty_noteffective, cba.openorderqty_noteffective), \
             cba.lastupdatedate = 20250128 \
WHEN NOT MATCHED THEN \
  INSERT (filialnr, artikel_nr, besla_nr, bestand_min, artikelaktiv, lagerfachnr, offene_bestmenge, openorderqty_noteffective, lastupdatedate) \
  VALUES (taf.filialnr, taf.artikel_nr, NVL(taf.besla_nr, 0), NVL(taf.bestand_min, 0), NVL(taf.artikelaktiv, 'Y'), \
          NVL(taf.lagerfachnr, 'UNKNOWN'), NVL(taf.offene_bestmenge, 0), NVL(taf.openorderqty_noteffective, 0), 20250128);

# ==============================================================================
# PHASE 10: PERFORMANCE VALIDATION - Test timing and efficiency
# ==============================================================================

# Performance test - large result set with aggregations
[transaction43]
sql=SELECT (cba.filialnr || ';' || COUNT(*) || ';' || \
           SUM(cba.bestand_min) || ';' || SUM(cba.offene_bestmenge) || ';' || \
           MIN(cba.lastupdatedate) || ';' || MAX(cba.lastupdatedate)) AS result \
FROM ich21@zdev21_tcp:temp_cscbrancharticle cba \
GROUP BY cba.filialnr \
ORDER BY COUNT(*) DESC;
header=filialnr;record_count;total_min_stock;total_open_orders;min_update_date;max_update_date
limit=20

# Test complex joins (simulates module's complex operations)
[transaction44]
sql=SELECT (cba.filialnr || ';' || br.branchname || ';' || cba.artikel_nr || ';' || \
           cba.bestand_min || ';' || cba.offene_bestmenge || ';' || cba.artikelaktiv || ';' || cba.lastupdatedate) AS result \
FROM ich21@zdev21_tcp:temp_cscbrancharticle cba, \
     ich21@zdev21_tcp:temp_branch_reference br \
WHERE cba.filialnr = br.filialnr \
  AND br.active_flag = 1 \
  AND cba.artikelaktiv = 'Y' \
ORDER BY cba.bestand_min DESC, cba.artikel_nr;
header=filialnr;branchname;artikel_nr;bestand_min;offene_bestmenge;artikelaktiv;lastupdatedate
limit=15

# ==============================================================================
# PHASE 11: FINAL VALIDATION - Comprehensive data integrity check
# ==============================================================================

# Final record counts
[transaction45]
sql=INSERT INTO ich21@zdev21_tcp:temp_validation_results \
SELECT 'FINAL_VALIDATION', 'total_records', COUNT(*), 'Total records in final table' \
FROM ich21@zdev21_tcp:temp_cscbrancharticle;

[transaction46]
sql=INSERT INTO ich21@zdev21_tcp:temp_validation_results \
SELECT 'FINAL_VALIDATION', 'unique_branches', COUNT(DISTINCT filialnr), 'Number of unique branches' \
FROM ich21@zdev21_tcp:temp_cscbrancharticle;

[transaction47]
sql=INSERT INTO ich21@zdev21_tcp:temp_validation_results \
SELECT 'FINAL_VALIDATION', 'unique_articles', COUNT(DISTINCT artikel_nr), 'Number of unique articles' \
FROM ich21@zdev21_tcp:temp_cscbrancharticle;

[transaction48]
sql=INSERT INTO ich21@zdev21_tcp:temp_validation_results \
SELECT 'FINAL_VALIDATION', 'recent_updates', COUNT(*), 'Records updated since 20250126' \
FROM ich21@zdev21_tcp:temp_cscbrancharticle \
WHERE lastupdatedate >= 20250126;

# Display final validation results
[transaction49]
sql=SELECT (validation_type || ';' || metric_name || ';' || metric_value || ';' || description) AS result \
FROM ich21@zdev21_tcp:temp_validation_results \
WHERE validation_type = 'FINAL_VALIDATION' \
ORDER BY metric_name;
header=validation_type;metric;value;description

# Data consistency cross-check
[transaction50]
sql=SELECT (cba.filialnr || ';' || \
           COUNT(*) || ';' || \
           COUNT(CASE WHEN cba.artikelaktiv = 'Y' THEN 1 END) || ';' || \
           COUNT(CASE WHEN cba.bestand_min > 0 THEN 1 END)) AS result \
FROM ich21@zdev21_tcp:temp_cscbrancharticle cba \
GROUP BY cba.filialnr \
HAVING COUNT(*) > 0 \
ORDER BY cba.filialnr;
header=filialnr;total_records;active_articles;positive_stock

# ==============================================================================
# PHASE 12: CLEANUP - Drop temporary tables and finish
# ==============================================================================

# Drop all temporary tables
[transaction51]
sql=DROP TABLE ich21@zdev21_tcp:temp_artikelf_source;

[transaction52]
sql=DROP TABLE ich21@zdev21_tcp:temp_cscbrancharticle;

[transaction53]
sql=DROP TABLE ich21@zdev21_tcp:temp_processing_artikelf;

[transaction54]
sql=DROP TABLE ich21@zdev21_tcp:temp_branch_reference;

[transaction55]
sql=DROP TABLE ich21@zdev21_tcp:temp_validation_results;

# Final cleanup verification
[transaction56]
sql=SELECT COUNT(*) AS cleanup_check FROM systables WHERE tabname LIKE 'temp_%';
header=remaining_temp_tables

# ==============================================================================
# END OF CONFIGURATION
# ==============================================================================