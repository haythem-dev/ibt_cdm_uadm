# ==============================================================================
# LoadPubranchsupplier Module Validation Configuration
# esqltest Framework Configuration File - INFORMIX UPGRADE VALIDATION
# 
# Module: pharmos.outbound.csc_load/dev/src/loadpubranchsupplier
# Purpose: Validate supplier branch data loading during Informix V12.10FC10 -> V14.10FC10 upgrade
# Target Binary: loadpubranchsupplier.bin
# Date: 2025-09-01
# Version: 1.0 (Informix Upgrade Validation Suite)
# ==============================================================================

[general]
database=ich21@zdev21_tcp
test_capture_entries_count=10
keepDBConnection=1
separator=;
timeout=600
commit_interval=1

# ==============================================================================
# PHASE 1: CLEANUP AND ENVIRONMENT SETUP
# ==============================================================================

# Clean up any existing temporary tables from previous runs
[transaction00]
sql=DROP TABLE IF EXISTS temp_fliefer_source;

[transaction01]
sql=DROP TABLE IF EXISTS temp_pubranchsupplier;

[transaction02]
sql=DROP TABLE IF EXISTS temp_tmp_fliefer;

[transaction03]
sql=DROP TABLE IF EXISTS temp_validation_results;

[transaction04]
sql=DROP TABLE IF EXISTS temp_branch_config;

# ==============================================================================
# PHASE 2: TABLE STRUCTURE SETUP - Simulate loadpubranchsupplier environment
# ==============================================================================

# Create source table (simulates inbound fliefer table)
[transaction05]
sql=CREATE TEMP TABLE temp_fliefer_source ( \
    filialnr INTEGER NOT NULL, \
    besla_nr INTEGER NOT NULL, \
    datum_next_bestell INTEGER, \
    datum_last_hbv INTEGER, \
    lz_haupt INTEGER, \
    vz_bestellung CHAR(1), \
    PRIMARY KEY (filialnr, besla_nr) \
);

# Create target table (simulates outbound pubranchsupplier table)
[transaction06]
sql=CREATE TEMP TABLE temp_pubranchsupplier ( \
    filialnr INTEGER NOT NULL, \
    besla_nr INTEGER NOT NULL, \
    datum_next_bestell INTEGER, \
    lz_haupt INTEGER, \
    vz_bestellung CHAR(1), \
    lastupdatedate INTEGER DEFAULT 0, \
    PRIMARY KEY (filialnr, besla_nr) \
);

# Create processing table (simulates tmp_fliefer used by module)
[transaction07]
sql=CREATE TEMP TABLE temp_tmp_fliefer ( \
    filialnr INTEGER, \
    besla_nr INTEGER, \
    datum_next_bestell INTEGER, \
    datum_last_hbv INTEGER, \
    lz_haupt INTEGER, \
    vz_bestellung CHAR(1) \
);

# Create branch configuration reference table
[transaction08]
sql=CREATE TEMP TABLE temp_branch_config ( \
    filialnr INTEGER NOT NULL PRIMARY KEY, \
    branchname VARCHAR(50), \
    region VARCHAR(20), \
    active_flag INTEGER DEFAULT 1, \
    last_processing_date INTEGER DEFAULT 0 \
);

# Create validation results tracking table
[transaction09]
sql=CREATE TEMP TABLE temp_validation_results ( \
    test_phase VARCHAR(50), \
    metric_name VARCHAR(50), \
    metric_value INTEGER, \
    expected_value INTEGER, \
    status VARCHAR(10), \
    description VARCHAR(150) \
);

# ==============================================================================
# PHASE 3: REFERENCE DATA LOADING - Setup test branches and suppliers
# ==============================================================================

# Load branch configuration data for multi-branch testing
[transaction10]
sql=INSERT INTO temp_branch_config (filialnr, branchname, region, active_flag, last_processing_date) VALUES (10, 'Berlin Central Pharmacy', 'North', 1, 20250125);

[transaction11]
sql=INSERT INTO temp_branch_config (filialnr, branchname, region, active_flag, last_processing_date) VALUES (20, 'Munich Regional Pharmacy', 'South', 1, 20250125);

[transaction12]
sql=INSERT INTO temp_branch_config (filialnr, branchname, region, active_flag, last_processing_date) VALUES (30, 'Vienna Metro Pharmacy', 'Central', 1, 20250124);

[transaction13]
sql=INSERT INTO temp_branch_config (filialnr, branchname, region, active_flag, last_processing_date) VALUES (50, 'Frankfurt City Pharmacy', 'West', 1, 20250123);

# Load existing historical data in target table (pre-existing supplier records)
[transaction14]
sql=INSERT INTO temp_pubranchsupplier (filialnr, besla_nr, datum_next_bestell, lz_haupt, vz_bestellung, lastupdatedate) VALUES (10, 1001, 20250201, 7, 'W', 20250125);

[transaction15]
sql=INSERT INTO temp_pubranchsupplier (filialnr, besla_nr, datum_next_bestell, lz_haupt, vz_bestellung, lastupdatedate) VALUES (10, 1002, 20250203, 14, 'M', 20250125);

[transaction16]
sql=INSERT INTO temp_pubranchsupplier (filialnr, besla_nr, datum_next_bestell, lz_haupt, vz_bestellung, lastupdatedate) VALUES (20, 1001, 20250202, 10, 'W', 20250125);

[transaction17]
sql=INSERT INTO temp_pubranchsupplier (filialnr, besla_nr, datum_next_bestell, lz_haupt, vz_bestellung, lastupdatedate) VALUES (30, 1003, 20250205, 21, 'M', 20250124);

# Load source data (simulates inbound fliefer with mixed update scenarios)
[transaction18]
sql=INSERT INTO temp_fliefer_source (filialnr, besla_nr, datum_next_bestell, datum_last_hbv, lz_haupt, vz_bestellung) VALUES (10, 1001, 20250210, 20250126, 5, 'W');

[transaction19]
sql=INSERT INTO temp_fliefer_source (filialnr, besla_nr, datum_next_bestell, datum_last_hbv, lz_haupt, vz_bestellung) VALUES (10, 1004, 20250212, 20250126, 7, 'W');

[transaction20]
sql=INSERT INTO temp_fliefer_source (filialnr, besla_nr, datum_next_bestell, datum_last_hbv, lz_haupt, vz_bestellung) VALUES (20, 1005, 20250215, 20250126, 14, 'M');

[transaction21]
sql=INSERT INTO temp_fliefer_source (filialnr, besla_nr, datum_next_bestell, datum_last_hbv, lz_haupt, vz_bestellung) VALUES (50, 1006, 20250218, 20250126, 21, 'M');

# ==============================================================================
# PHASE 4: BASIC QUERY VALIDATION - Test environment setup
# ==============================================================================

# Validate setup - record counts
[transaction22]
sql=SELECT (COUNT(*) || ';TOTAL_BRANCH_CONFIG_RECORDS') AS result FROM temp_branch_config;
header=count;description

[transaction23]
sql=SELECT (COUNT(*) || ';TOTAL_SOURCE_RECORDS') AS result FROM temp_fliefer_source;
header=count;description

[transaction24]
sql=SELECT (COUNT(*) || ';TOTAL_TARGET_RECORDS_INITIAL') AS result FROM temp_pubranchsupplier;
header=count;description

# Record initial metrics for validation
[transaction25]
sql=INSERT INTO temp_validation_results SELECT 'SETUP', 'branch_count', COUNT(*), 4, 'PASS', 'Number of test branches configured' FROM temp_branch_config;

[transaction26]
sql=INSERT INTO temp_validation_results SELECT 'SETUP', 'source_records', COUNT(*), 4, 'PASS', 'Source fliefer records loaded' FROM temp_fliefer_source;

[transaction27]
sql=INSERT INTO temp_validation_results SELECT 'SETUP', 'initial_target', COUNT(*), 4, 'PASS', 'Initial pubranchsupplier records' FROM temp_pubranchsupplier;

# ==============================================================================
# PHASE 5: INCREMENTAL LOADING SIMULATION - Test module's core logic
# ==============================================================================

# Test incremental data selection for branch 10 (simulates module's core SELECT with NVL)
[transaction28]
sql=SELECT (s.filialnr || ';' || s.besla_nr || ';' || NVL(s.datum_next_bestell, 0) || ';' || s.datum_last_hbv || ';' || NVL(s.lz_haupt, 0) || ';' || NVL(s.vz_bestellung, 'N') || ';INCREMENTAL_SELECT') AS result \
FROM temp_fliefer_source s \
WHERE s.filialnr = 10 \
  AND s.datum_last_hbv >= (SELECT NVL(MAX(lastupdatedate), 0) FROM temp_pubranchsupplier WHERE filialnr = 10) \
ORDER BY s.besla_nr;
header=filialnr;besla_nr;datum_next_bestell;datum_last_hbv;lz_haupt;vz_bestellung;operation

# Clear processing table (simulates module's tmp_fliefer preparation)
[transaction29]
sql=DELETE FROM temp_tmp_fliefer;

# Load processing table with incremental data (simulates module's INSERT logic)
[transaction30]
sql=INSERT INTO temp_tmp_fliefer \
SELECT filialnr, besla_nr, datum_next_bestell, datum_last_hbv, lz_haupt, vz_bestellung \
FROM temp_fliefer_source \
WHERE filialnr = 10 \
  AND datum_last_hbv >= (SELECT NVL(MAX(lastupdatedate), 0) FROM temp_pubranchsupplier WHERE filialnr = 10);

# Validate processing table load
[transaction31]
sql=SELECT (COUNT(*) || ';PROCESSING_RECORDS_LOADED_BRANCH_10') AS result FROM temp_tmp_fliefer;
header=count;description

# ==============================================================================
# PHASE 6: MERGE OPERATION TESTING - Test UPDATE/INSERT logic
# ==============================================================================

# Execute MERGE operation for branch 10 (simulates module's core MERGE with currentDate)
[transaction32]
sql=MERGE INTO temp_pubranchsupplier AS cba \
USING temp_tmp_fliefer AS taf \
ON cba.filialnr = taf.filialnr AND cba.besla_nr = taf.besla_nr \
WHEN MATCHED THEN \
  UPDATE SET cba.datum_next_bestell = taf.datum_next_bestell, \
             cba.lz_haupt = taf.lz_haupt, \
             cba.vz_bestellung = taf.vz_bestellung, \
             cba.lastupdatedate = 20250126 \
WHEN NOT MATCHED THEN \
  INSERT (filialnr, besla_nr, datum_next_bestell, lz_haupt, vz_bestellung, lastupdatedate) \
  VALUES (taf.filialnr, taf.besla_nr, taf.datum_next_bestell, taf.lz_haupt, taf.vz_bestellung, 20250126);

# Validate MERGE results
[transaction33]
sql=SELECT (COUNT(*) || ';RECORDS_UPDATED_TODAY_BRANCH_10') AS result FROM temp_pubranchsupplier WHERE filialnr = 10 AND lastupdatedate = 20250126;
header=count;description

[transaction34]
sql=SELECT (COUNT(*) || ';TOTAL_RECORDS_BRANCH_10') AS result FROM temp_pubranchsupplier WHERE filialnr = 10;
header=count;description

# Record merge metrics
[transaction35]
sql=INSERT INTO temp_validation_results SELECT 'MERGE', 'branch_10_updated', COUNT(*), 2, 'PASS', 'Records updated for branch 10' FROM temp_pubranchsupplier WHERE filialnr = 10 AND lastupdatedate = 20250126;

# ==============================================================================
# PHASE 7: DELETION/CLEANUP SIMULATION - Test orphaned record cleanup
# ==============================================================================

# Test cleanup selection (simulates module's cleanup SELECT with LEFT OUTER JOIN)
[transaction36]
sql=SELECT (cba.filialnr || ';' || cba.besla_nr || ';CLEANUP_CANDIDATE') AS result \
FROM temp_pubranchsupplier cba \
LEFT OUTER JOIN temp_fliefer_source af \
  ON cba.filialnr = af.filialnr AND cba.besla_nr = af.besla_nr \
WHERE cba.filialnr = 10 AND af.besla_nr IS NULL \
ORDER BY cba.besla_nr;
header=filialnr;besla_nr;cleanup_status

# Count records before cleanup
[transaction37]
sql=SELECT (COUNT(*) || ';RECORDS_BEFORE_CLEANUP_BRANCH_10') AS result FROM temp_pubranchsupplier WHERE filialnr = 10;
header=count;description

# Execute cleanup deletion (simulates module's DELETE logic)
[transaction38]
sql=DELETE FROM temp_pubranchsupplier \
WHERE filialnr = 10 \
  AND besla_nr IN ( \
    SELECT cba.besla_nr FROM temp_pubranchsupplier cba \
    LEFT OUTER JOIN temp_fliefer_source af \
      ON cba.filialnr = af.filialnr AND cba.besla_nr = af.besla_nr \
    WHERE cba.filialnr = 10 AND af.besla_nr IS NULL \
  );

# Validate cleanup results
[transaction39]
sql=SELECT (COUNT(*) || ';RECORDS_AFTER_CLEANUP_BRANCH_10') AS result FROM temp_pubranchsupplier WHERE filialnr = 10;
header=count;description

# Record cleanup metrics
[transaction40]
sql=INSERT INTO temp_validation_results SELECT 'CLEANUP', 'branch_10_final', COUNT(*), 2, 'PASS', 'Final records after cleanup for branch 10' FROM temp_pubranchsupplier WHERE filialnr = 10;

# ==============================================================================
# PHASE 8: MULTI-BRANCH BATCH PROCESSING - Test concurrent branch operations
# ==============================================================================

# Clear processing table for multi-branch test
[transaction41]
sql=DELETE FROM temp_tmp_fliefer;

# Load processing data for multiple branches
[transaction42]
sql=INSERT INTO temp_tmp_fliefer \
SELECT filialnr, besla_nr, datum_next_bestell, datum_last_hbv, lz_haupt, vz_bestellung \
FROM temp_fliefer_source \
WHERE filialnr IN (20, 50) \
  AND datum_last_hbv >= (SELECT NVL(MAX(bc.last_processing_date), 0) FROM temp_branch_config bc WHERE bc.filialnr = temp_fliefer_source.filialnr);

# Execute batch MERGE for multiple branches
[transaction43]
sql=MERGE INTO temp_pubranchsupplier AS cba \
USING temp_tmp_fliefer AS taf \
ON cba.filialnr = taf.filialnr AND cba.besla_nr = taf.besla_nr \
WHEN MATCHED THEN \
  UPDATE SET cba.datum_next_bestell = taf.datum_next_bestell, \
             cba.lz_haupt = taf.lz_haupt, \
             cba.vz_bestellung = taf.vz_bestellung, \
             cba.lastupdatedate = 20250126 \
WHEN NOT MATCHED THEN \
  INSERT (filialnr, besla_nr, datum_next_bestell, lz_haupt, vz_bestellung, lastupdatedate) \
  VALUES (taf.filialnr, taf.besla_nr, taf.datum_next_bestell, taf.lz_haupt, taf.vz_bestellung, 20250126);

# Validate multi-branch processing
[transaction44]
sql=SELECT (bc.branchname || ';' || COUNT(ps.besla_nr) || ';' || NVL(MAX(ps.lastupdatedate), 0) || ';MULTI_BRANCH_RESULT') AS result \
FROM temp_branch_config bc \
LEFT JOIN temp_pubranchsupplier ps ON bc.filialnr = ps.filialnr \
WHERE bc.filialnr IN (20, 50) \
GROUP BY bc.filialnr, bc.branchname \
ORDER BY bc.filialnr;
header=branchname;supplier_count;last_update;operation

# ==============================================================================
# PHASE 9: DATA QUALITY VALIDATION - Test data integrity
# ==============================================================================

# Data quality checks - Record metrics
[transaction45]
sql=INSERT INTO temp_validation_results SELECT 'DATA_QUALITY', 'null_lz_haupt', COUNT(*), 0, 'PASS', 'Records with NULL lz_haupt' FROM temp_pubranchsupplier WHERE lz_haupt IS NULL;

[transaction46]
sql=INSERT INTO temp_validation_results SELECT 'DATA_QUALITY', 'invalid_vz_bestellung', COUNT(*), 0, 'PASS', 'Records with invalid vz_bestellung' FROM temp_pubranchsupplier WHERE vz_bestellung NOT IN ('W', 'M', 'D');

[transaction47]
sql=INSERT INTO temp_validation_results SELECT 'DATA_QUALITY', 'future_dates', COUNT(*), 0, 'PASS', 'Records with future next order dates' FROM temp_pubranchsupplier WHERE datum_next_bestell > 20251231;

[transaction48]
sql=INSERT INTO temp_validation_results SELECT 'DATA_QUALITY', 'negative_lead_time', COUNT(*), 0, 'PASS', 'Records with negative lead time' FROM temp_pubranchsupplier WHERE lz_haupt < 0;

# Display data quality results
[transaction49]
sql=SELECT (test_phase || ';' || metric_name || ';' || metric_value || ';' || status || ';' || description) AS result FROM temp_validation_results WHERE test_phase = 'DATA_QUALITY' ORDER BY metric_name;
header=phase;metric;value;status;description

# ==============================================================================
# PHASE 10: PERFORMANCE AND STRESS TESTING - Test large dataset handling
# ==============================================================================

# Generate larger dataset for stress testing - Fixed to avoid duplicate keys
[transaction50]
sql=INSERT INTO temp_fliefer_source (filialnr, besla_nr, datum_next_bestell, datum_last_hbv, lz_haupt, vz_bestellung) VALUES (30, 2001, 20250221, 20250127, 8, 'W');

# Add additional stress test records with unique keys
[transaction50a]
sql=INSERT INTO temp_fliefer_source (filialnr, besla_nr, datum_next_bestell, datum_last_hbv, lz_haupt, vz_bestellung) VALUES (30, 2002, 20250222, 20250127, 10, 'M');

[transaction50b]
sql=INSERT INTO temp_fliefer_source (filialnr, besla_nr, datum_next_bestell, datum_last_hbv, lz_haupt, vz_bestellung) VALUES (30, 2003, 20250223, 20250127, 12, 'W');


# Clear and reload processing table for stress test
[transaction51]
sql=DELETE FROM temp_tmp_fliefer;

[transaction52]
sql=INSERT INTO temp_tmp_fliefer \
SELECT filialnr, besla_nr, datum_next_bestell, datum_last_hbv, lz_haupt, vz_bestellung \
FROM temp_fliefer_source \
WHERE filialnr = 30 \
  AND datum_last_hbv >= (SELECT NVL(MAX(lastupdatedate), 0) FROM temp_pubranchsupplier WHERE filialnr = 30);

# Execute stress test MERGE
[transaction53]
sql=MERGE INTO temp_pubranchsupplier AS cba \
USING temp_tmp_fliefer AS taf \
ON cba.filialnr = taf.filialnr AND cba.besla_nr = taf.besla_nr \
WHEN MATCHED THEN \
  UPDATE SET cba.datum_next_bestell = taf.datum_next_bestell, \
             cba.lz_haupt = taf.lz_haupt, \
             cba.vz_bestellung = taf.vz_bestellung, \
             cba.lastupdatedate = 20250127 \
WHEN NOT MATCHED THEN \
  INSERT (filialnr, besla_nr, datum_next_bestell, lz_haupt, vz_bestellung, lastupdatedate) \
  VALUES (taf.filialnr, taf.besla_nr, taf.datum_next_bestell, taf.lz_haupt, taf.vz_bestellung, 20250127);

# Performance validation
[transaction54]
sql=SELECT (COUNT(*) || ';STRESS_TEST_RECORDS_PROCESSED') AS result FROM temp_pubranchsupplier WHERE filialnr = 30 AND lastupdatedate = 20250127;
header=count;description

# ==============================================================================
# PHASE 11: INFORMIX VERSION COMPATIBILITY TESTING - Test specific V14 features
# ==============================================================================

# Test Informix V14 JSON compatibility (if available)
[transaction55]
sql=SELECT (ps.filialnr || ';' || ps.besla_nr || ';' || NVL(ps.lz_haupt, 0) || ';' || NVL(ps.vz_bestellung, 'N') || ';JSON_COMPAT_TEST') AS result \
FROM temp_pubranchsupplier ps \
WHERE ps.filialnr = 10 \
ORDER BY ps.besla_nr;
header=filialnr;besla_nr;lz_haupt;vz_bestellung;test_type

# Test advanced aggregation functions (V14 enhancements)
[transaction56]
sql=SELECT (ps.filialnr || ';' || COUNT(*) || ';' || AVG(ps.lz_haupt) || ';' || \
           COUNT(CASE WHEN ps.vz_bestellung = 'W' THEN 1 END) || ';' || \
           COUNT(CASE WHEN ps.vz_bestellung = 'M' THEN 1 END)) AS result \
FROM temp_pubranchsupplier ps \
GROUP BY ps.filialnr \
ORDER BY ps.filialnr;
header=filialnr;total_suppliers;avg_lead_time;weekly_count;monthly_count

# Test window functions (V14 compatibility)
[transaction57]
sql=SELECT (ps.filialnr || ';' || ps.besla_nr || ';' || ps.lz_haupt || ';' || \
           RANK() OVER (PARTITION BY ps.filialnr ORDER BY ps.lz_haupt) || ';WINDOW_FUNCTION_TEST') AS result \
FROM temp_pubranchsupplier ps \
WHERE ps.filialnr IN (10, 20) \
ORDER BY ps.filialnr, ps.lz_haupt;
header=filialnr;besla_nr;lz_haupt;rank;test_type

# ==============================================================================
# PHASE 12: FINAL VALIDATION AND REPORTING - Comprehensive results
# ==============================================================================

# Collect final validation metrics
[transaction58]
sql=INSERT INTO temp_validation_results SELECT 'FINAL', 'total_suppliers', COUNT(*), 6, 'PENDING', 'Total supplier records processed' FROM temp_pubranchsupplier;

[transaction59]
sql=INSERT INTO temp_validation_results SELECT 'FINAL', 'unique_branches', COUNT(DISTINCT filialnr), 4, 'PENDING', 'Unique branches with suppliers' FROM temp_pubranchsupplier;

[transaction60]
sql=INSERT INTO temp_validation_results SELECT 'FINAL', 'recent_updates', COUNT(*), 4, 'PENDING', 'Records updated in current session' FROM temp_pubranchsupplier WHERE lastupdatedate >= 20250126;

[transaction61]
sql=INSERT INTO temp_validation_results SELECT 'FINAL', 'weekly_suppliers', COUNT(*), 2, 'PENDING', 'Weekly delivery suppliers' FROM temp_pubranchsupplier WHERE vz_bestellung = 'W';

[transaction62]
sql=INSERT INTO temp_validation_results SELECT 'FINAL', 'monthly_suppliers', COUNT(*), 3, 'PENDING', 'Monthly delivery suppliers' FROM temp_pubranchsupplier WHERE vz_bestellung = 'M';

# Update validation status based on results
[transaction63]
sql=UPDATE temp_validation_results SET status = CASE WHEN metric_value = expected_value THEN 'PASS' ELSE 'FAIL' END WHERE test_phase = 'FINAL';

# Display comprehensive validation report
[transaction64]
sql=SELECT (test_phase || ';' || metric_name || ';' || metric_value || ';' || expected_value || ';' || status || ';' || description) AS result FROM temp_validation_results ORDER BY test_phase, metric_name;
header=phase;metric;actual;expected;status;description

# Final summary by branch
[transaction65]
sql=SELECT (bc.branchname || ';' || bc.filialnr || ';' || COUNT(ps.besla_nr) || ';' || \
           AVG(ps.lz_haupt) || ';' || MAX(ps.lastupdatedate) || ';' || bc.region) AS result \
FROM temp_branch_config bc \
LEFT JOIN temp_pubranchsupplier ps ON bc.filialnr = ps.filialnr \
GROUP BY bc.filialnr, bc.branchname, bc.region \
ORDER BY COUNT(ps.besla_nr) DESC;
header=branchname;filialnr;supplier_count;avg_lead_time;last_update;region

# ==============================================================================
# PHASE 13: CLEANUP - Remove temporary tables
# ==============================================================================

# Drop all temporary tables created during testing
[transaction66]
sql=DROP TABLE temp_fliefer_source;

[transaction67]
sql=DROP TABLE temp_pubranchsupplier;

[transaction68]
sql=DROP TABLE temp_tmp_fliefer;

[transaction69]
sql=DROP TABLE temp_branch_config;

[transaction70]
sql=DROP TABLE temp_validation_results;

# Final cleanup verification
[transaction71]
sql=SELECT (COUNT(*) || ';REMAINING_TEMP_TABLES') AS result FROM systables WHERE tabname LIKE 'temp_%';
header=count;description

# ==============================================================================
# END OF CONFIGURATION - INFORMIX UPGRADE VALIDATION COMPLETE
# ==============================================================================